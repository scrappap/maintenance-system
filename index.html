<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Maintenance Schedule</title>
  <link rel="icon" type="image/png" href="LOGO JKB.png">
  <style>
    body{font-family:Arial, sans-serif;padding:20px}
    h2{margin-bottom:10px}
    table{border-collapse:collapse;width:100%;background:white}
    th,td{border:1px solid #ccc;padding:8px;text-align:left}
    th{background:#2d6cdf;color:white}
    tr:nth-child(even){background:#f2f2f2}
    button{margin-top:10px;padding:8px 14px;border:none;background:#2d6cdf;color:white;border-radius:8px;cursor:pointer}
    button:hover{opacity:.9}
    td{min-width:120px}
    .controls{margin-bottom:12px;display:flex;gap:10px}
    .overdue{background:#ffb3b3 !important}
    #calendar{margin:20px 0;padding:15px;background:white;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px}
    .day{border:1px solid #ddd;min-height:80px;padding:5px;border-radius:8px;background:#fafafa;font-size:12px}
    .note{margin-top:4px;color:#2d6cdf;font-size:11px}
    .day.today{outline:2px solid #2d6cdf}
    .dot{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:3px}
    .w-Weekly{background:#27ae60}.w-Monthly{background:#f39c12}.w-Quarterly{background:#8e44ad}.w-Half-Year{background:#16a085}.w-Yearly{background:#c0392b}
    .tooltip{position:absolute;background:#2d6cdf;color:#fff;padding:6px 8px;border-radius:6px;font-size:11px;pointer-events:none;z-index:10;white-space:pre}
    .miniPopupWrap{position:fixed;inset:0;background:rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center}
    .miniPopup{background:white;padding:15px;border-radius:10px;min-width:220px;max-width:320px;box-shadow:0 5px 20px rgba(0,0,0,.2);font-size:13px}
    .miniPopup h4{margin:0 0 8px 0}
    .miniPopup button{margin-top:10px;width:100%;background:#2d6cdf}
  </style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage" class="login-wrap">
  
  <div class="login-card">
    <h2>Log in</h2>
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password" onkeydown="if(event.key==='Enter') login()">
    <button id="loginBtn" onclick="login()">LOG IN</button>
    <p id="loginMsg"></p>
    <div id="loginLoading" style="display:none;font-size:12px;color:#555">Checking...</div>
  </div>
</div>

<style>
  body{
    font-family:Arial, sans-serif;
    background:url('maintenance.png') center/cover no-repeat fixed;
    padding:0;
  }
  /* gelapkan sikit supaya card jelas */
  body:before{
    content:"";
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.35);
    z-index:-1;
  }
  .login-wrap{display:flex;flex-direction:column;align-items:center;gap:20px;margin:20px}
  .login-hero img{max-width:900px;width:100%}
  .login-card{width:320px;background:white;padding:18px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.15);display:flex;flex-direction:column;gap:10px}
  .login-card h2{margin:0 0 5px 0}
  .login-card input{padding:10px;border:1px solid #ccc;border-radius:8px}
  .login-card button{background:#f0ad2c;color:#000;font-weight:bold;border-radius:8px}
  .login-card #loginMsg{color:#c0392b;font-size:12px;min-height:14px}
</style>

<div id="homePage" style="display:none">
  <h2>Dashboard</h2>
  <p id="summary"></p>
  <div id="whoami" style="font-size:12px;color:#555"></div>

  <!-- KPI CARDS -->
  <div id="kpiCards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin:15px 0"></div>

  <!-- BY DEPARTMENT -->
  <h3>Summary by Department</h3>
  <div id="homeStats" style="display:flex;gap:15px;flex-wrap:wrap"></div>

  <button onclick="openSystem()">Enter System</button>
  <button onclick="logout()" style="background:#7f8c8d">Logout</button>
  <hr style="margin:20px 0">
</div>

<div id="mainSystem" style="display:none">

<h2>Asset Maintenance Schedule</h2>

<div class="controls">
  <input type="text" id="searchBox" placeholder="Search anything...">
  <select id="assetFilter"><option value="">Filter Asset Desc</option></select>
  <select id="locFilter"><option value="">Filter Location</option></select>
</div>

<div id="calendarControls" style="display:flex;gap:10px;align-items:center;margin-top:10px">
  <button onclick="changeMonth(-1)">◀</button>
  <b id="monthLabel"></b>
  <button onclick="changeMonth(1)">▶</button>
</div>
<div id="calendar"></div>
<div id="tooltip" class="tooltip" style="display:none"></div>

<table id="assetTable">
  <thead>
    <tr>
      <th><input type="checkbox" onclick="toggleAll(this)"></th>
      <th>ASSET NO</th>
      <th>TYPE CODE</th>
      <th>ASSET DESCRIPTION</th>
      <th>LOCATION DESCRIPTION</th>
      <th>DEPT DESCRIPTION</th>
      <th>LEVEL</th>
      <th>FREQUENCY</th>
      <th>TARGET DATE</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button onclick="addRow()">+ Add Row</button>
<input type="file" id="excelFile" accept=".xlsx,.xls" />
<button onclick="importExcel()">Import Excel</button>
<button onclick="exportJSON()">Export JSON</button>
<button onclick="exportExcel()">Export Excel</button>
<button onclick="exportHTML()">Export HTML</button>
<button onclick="deleteSelected()" style="background:#c0392b">Delete Selected</button>
<button onclick="loadFromSheet()" style="background:#16a085">Sync Google Sheet</button>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://apis.google.com/js/api.js"></script>
<script>
/* ==============================
   GOOGLE SHEET CONFIG (ISI SENDIRI)
============================== */
// DAPATKAN dari Google Cloud / Apps Script
const SHEET_ID = "PASTE_SHEET_ID"; 
const API_KEY = "PASTE_API_KEY";
const RANGE = "Sheet1!A2:H"; // mula dari baris data

async function loadFromSheet(){
  if(!SHEET_ID||SHEET_ID.includes('PASTE')){
    alert('Please fill in SHEET_ID & API_KEY first');
    return;
  }

  const url=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
  const res=await fetch(url);
  const data=await res.json();
  if(!data.values){alert('No data');return;}

  const tbody=document.querySelector('#assetTable tbody');
  tbody.innerHTML='';

  data.values.forEach(r=>{
    const row=tbody.insertRow();
    row.insertCell().innerHTML='<input type="checkbox" class="rowCheck">';
    for(let i=0;i<8;i++){
      const c=row.insertCell();
      c.contentEditable='true';
      c.textContent=r[i]||'';
    }
  });
  saveTable();
  alert('Sync completed');
}

/* ==============================
   GLOBAL & INIT
============================== */
const STORAGE_KEY="assetTableData";
let viewDate=new Date();

// pastikan semua function wujud sebelum digunakan
window.addEventListener("DOMContentLoaded",()=>{
  if(!localStorage.getItem(STORAGE_KEY)) addRow();
  loadTable();
  refreshFilters();
  checkOverdue();
  renderCalendar();
});

/* ==============================
   SAVE / LOAD
============================== */
function saveTable(){
  const rows=[...document.querySelectorAll("#assetTable tbody tr")];
  const data=rows.map(r=>[...r.children].slice(1).map(td=>td.textContent));
  localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
  renderCalendar();
}

function loadTable(){
  const saved=localStorage.getItem(STORAGE_KEY);
  if(!saved) return;
  const tbody=document.querySelector("#assetTable tbody");
  tbody.innerHTML="";
  JSON.parse(saved).forEach(r=>{
    const row=tbody.insertRow();
    row.insertCell().innerHTML='<input type="checkbox" class="rowCheck">';
    for(let i=0;i<8;i++){
      const c=row.insertCell();
      c.contentEditable="true";
      c.textContent=r[i]||"";
    }
  });
}

document.addEventListener("input",e=>{
  if(e.target.tagName==="TD"){
    refreshFilters();
    checkOverdue();
    saveTable();
  }
});

/* ==============================
   ROW MANAGEMENT
============================== */
function addRow(){
  const tbody=document.querySelector("#assetTable tbody");
  const row=tbody.insertRow();
  row.insertCell().innerHTML='<input type="checkbox" class="rowCheck">';
  for(let i=0;i<8;i++){
    const c=row.insertCell();
    c.contentEditable="true";
  }
  saveTable();
}

function toggleAll(master){
  document.querySelectorAll('.rowCheck').forEach(c=>c.checked=master.checked);
}

function deleteSelected(){
  const user=JSON.parse(localStorage.getItem('loggedUser')||'{}');
  if(user.role!=='admin'){
    alert('Only admin can delete');
    return;
  }
  document.querySelectorAll('.rowCheck:checked').forEach(c=>c.closest('tr').remove());
  saveTable();
}

/* ==============================
   IMPORT EXCEL
============================== */
function importExcel(){
  const file=document.getElementById("excelFile").files[0];
  if(!file){alert("Please select an Excel file first");return;}

  const reader=new FileReader();
  reader.onload=function(e){
    const data=new Uint8Array(e.target.result);
    const wb=XLSX.read(data,{type:"array"});
    const sheet=wb.Sheets[wb.SheetNames[0]];
    const json=XLSX.utils.sheet_to_json(sheet,{header:1});

    const tbody=document.querySelector("#assetTable tbody");
    tbody.innerHTML="";

    json.slice(1).forEach(r=>{
      const row=tbody.insertRow();
      row.insertCell().innerHTML='<input type="checkbox" class="rowCheck">';
      for(let i=0;i<8;i++){
        const c=row.insertCell();
        c.contentEditable="true";

        let val=r[i];
        // ==============================
        // FIX TARIKH EXCEL SERIAL NUMBER
        // ==============================
        if(i===7 && typeof val==='number'){
          const excelEpoch=new Date(1899,11,30);
          const realDate=new Date(excelEpoch.getTime()+val*86400000);
          val=realDate.toLocaleDateString('en-GB');
        }

        c.textContent=val||"";
      }
    });
    saveTable();
  };
  reader.readAsArrayBuffer(file);
}

/* ==============================
   EXPORT
============================== */
function getTableData(){
  return [...document.querySelectorAll("#assetTable tbody tr")]
    .map(r=>[...r.children].slice(1).map(td=>td.textContent));
}

function exportJSON(){
  const blob=new Blob([JSON.stringify(getTableData(),null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="jadual_aset.json";
  a.click();
}

function exportExcel(){
  const data=[["ASSET NO","TYPE CODE","ASSET DESCRIPTION","LOCATION DESCRIPTION","DEPT DESCRIPTION","LEVEL","FREQUENCY","TARGET DATE"],...getTableData()];
  const ws=XLSX.utils.aoa_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Sheet1");
  XLSX.writeFile(wb,"jadual_aset.xlsx");
}

function exportHTML(){
  const tableHTML=document.getElementById("assetTable").outerHTML;
  const html=`<!DOCTYPE html><html><head><meta charset=\"UTF-8\"><title>Export Jadual</title>
  <style>table{border-collapse:collapse;width:100%;font-family:Arial}th,td{border:1px solid #ccc;padding:8px}th{background:#2d6cdf;color:#fff}</style>
  </head><body><h2>Jadual Penyelenggaraan Aset</h2>${tableHTML}</body></html>`;
  const blob=new Blob([html],{type:"text/html"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="jadual_aset.html";
  a.click();
}

/* ==============================
   HOME PAGE NAVIGATION
============================== */
function openSystem(){
  document.getElementById('homePage').style.display='none';
  document.getElementById('mainSystem').style.display='block';
  updateSummary();
}

/* ==============================
   LOGIN SYSTEM
============================== */
// login now handled by Google Apps Script API
const LOGIN_API="https://script.google.com/macros/s/AKfycbxJ0-Q7GQedjY8yG3Nx37XwzhEgeD_0A5eIARIsuBA_L2rWGHYAyulvmEonMZ52pyHc/exec";

async function login(){
  const u=document.getElementById('username').value.trim();
  const p=document.getElementById('password').value.trim();

  if(!u||!p){
    document.getElementById('loginMsg').textContent="Enter username & password";
    return;
  }

  document.getElementById('loginMsg').textContent='';
  document.getElementById('loginLoading').style.display='block';
  document.getElementById('loginBtn').disabled=true;


  try{
    const res=await fetch(LOGIN_API,{
      method:'POST',
      body:JSON.stringify({username:u,password:p})
    });
    const data=await res.json();

    if(!data.ok){
      document.getElementById('loginMsg').textContent="Invalid login";
      return;
    }

    localStorage.setItem('loggedUser',JSON.stringify({u,role:data.role}));
    document.getElementById('loginPage').style.display='none';
    document.getElementById('homePage').style.display='block';
    updateSummary();
  }catch(err){
    document.getElementById('loginMsg').textContent="Server error";
  }
}

function logout(){
  localStorage.removeItem('loggedUser');
  location.reload();
}

// auto login jika pernah login
window.addEventListener('DOMContentLoaded',()=>{
  const lu=localStorage.getItem('loggedUser');
  if(lu){
    document.getElementById('loginPage').style.display='none';
    document.getElementById('homePage').style.display='block';
    showUser();
  }
});

function showUser(){
  const u=JSON.parse(localStorage.getItem('loggedUser')||'{}');
  const el=document.getElementById('whoami');
  if(el&&u.u) el.textContent=`Login as: ${u.u} (${u.role})`;
}



function updateSummary(){
  const total=document.querySelectorAll('#assetTable tbody tr').length;
  const overdue=document.querySelectorAll('#assetTable tbody tr.overdue').length;
  const today=new Date();
  today.setHours(0,0,0,0);

  let dueToday=0;
  document.querySelectorAll('#assetTable tbody tr').forEach(r=>{
    const txt=r.children[8].textContent.trim();
    if(!txt) return;
    let d=new Date(txt);
    if(isNaN(d)){
      const p=txt.split('/');
      if(p.length===3) d=new Date(p[2],p[1]-1,p[0]);
    }
    d.setHours(0,0,0,0);
    if(d.getTime()===today.getTime()) dueToday++;
  });

  const s=document.getElementById('summary');
  if(s) s.textContent=`Current Maintenance Status`;

  // KPI
  const kpi=document.getElementById('kpiCards');
  if(kpi){
    kpi.innerHTML=`
      <div style="background:white;padding:12px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,.1)"><b>Total Assets</b><br><span style="font-size:18px">${total}</span></div>
      <div style="background:white;padding:12px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,.1)"><b>Overdue</b><br><span style="font-size:18px;color:#c0392b">${overdue}</span></div>
      <div style="background:white;padding:12px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,.1)"><b>Due Today</b><br><span style="font-size:18px;color:#f39c12">${dueToday}</span></div>
    `;
  }

  const wrap=document.getElementById('homeStats');
  if(!wrap) return;

  const byDept={};
  document.querySelectorAll('#assetTable tbody tr').forEach(r=>{
    const dept=r.children[5].textContent||'-';
    byDept[dept]=(byDept[dept]||0)+1;
  });

  wrap.innerHTML=Object.entries(byDept).map(([k,v])=>
    `<div style="background:white;padding:10px 12px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,.1)"><b>${k}</b><br>${v} assets</div>`
  ).join('');
}

// update bila buka atau data berubah
window.addEventListener('DOMContentLoaded',()=>setTimeout(updateSummary,300));
document.addEventListener('input',()=>setTimeout(updateSummary,300));

/* ==============================
   SEARCH & FILTER
============================== */
const searchBox=document.getElementById("searchBox");
const assetFilter=document.getElementById("assetFilter");
const locFilter=document.getElementById("locFilter");

function refreshFilters(){
  if(!assetFilter||!locFilter) return;
  const rows=[...document.querySelectorAll("#assetTable tbody tr")];
  const assets=new Set();
  const locs=new Set();
  rows.forEach(r=>{
    if(r.children[3]) assets.add(r.children[3].textContent);
    if(r.children[4]) locs.add(r.children[4].textContent);
  });

  assetFilter.innerHTML='<option value="">Filter Asset Desc</option>';
  locFilter.innerHTML='<option value="">Filter Location</option>';
  assets.forEach(d=>assetFilter.innerHTML+=`<option>${d}</option>`);
  locs.forEach(l=>locFilter.innerHTML+=`<option>${l}</option>`);
}

function applyFilter(){
  const s=searchBox.value.toLowerCase();
  const d=assetFilter.value;
  const l=locFilter.value;

  document.querySelectorAll("#assetTable tbody tr").forEach(r=>{
    const text=r.innerText.toLowerCase();
    const matchSearch=text.includes(s);
    const matchDept=!d||r.children[3].textContent===d;
    const matchLoc=!l||r.children[4].textContent===l;
    r.style.display=(matchSearch&&matchDept&&matchLoc)?"":"none";
  });
}

if(searchBox) searchBox.addEventListener("input",applyFilter);
if(assetFilter) assetFilter.addEventListener("change",applyFilter);
if(locFilter) locFilter.addEventListener("change",applyFilter);

/* ==============================
   FREQUENCY DROPDOWN
============================== */
const freqOptions=["Weekly","Monthly","Quarterly","Half-Year","Yearly"];

// TIADA DATE PICKER – edit terus sebagai text sahaja
// (user request buang date picker supaya import Excel lebih stabil)
document.addEventListener("focusin",e=>{
  const td=e.target;
  if(td.tagName==="TD" && td.cellIndex===7){
    const val=td.textContent;
    td.innerHTML=`<select>${freqOptions.map(o=>`<option ${o===val?"selected":""}>${o}</option>`).join("")}</select>`;
    const sel=td.firstChild;
    sel.focus();
    sel.onblur=()=>{td.textContent=sel.value;saveTable();};
  }
});

/* ==============================
   OVERDUE
============================== */
function checkOverdue(){
    const today=new Date();
  today.setHours(0,0,0,0);
  document.querySelectorAll("#assetTable tbody tr").forEach(r=>{
    const txt=r.children[8].textContent.trim();
    if(!txt) return;
    let d=new Date(txt);
    if(isNaN(d)){
      const p=txt.split("/");
      if(p.length===3) d=new Date(p[2],p[1]-1,p[0]);
    }
    d.setHours(0,0,0,0);
    r.classList.toggle("overdue",d<today);
  });
}

/* ==============================
   CALENDAR
============================== */
function changeMonth(n){
  viewDate.setMonth(viewDate.getMonth()+n);
  renderCalendar();
}

function renderCalendar(){
  const y=viewDate.getFullYear();
  const m=viewDate.getMonth();
  const first=new Date(y,m,1);
  const last=new Date(y,m+1,0);
  const startDay=first.getDay();
  const days=last.getDate();

  const label=document.getElementById("monthLabel");
  if(label) label.textContent=viewDate.toLocaleString("ms-MY",{month:"long",year:"numeric"});

  const map={};
  document.querySelectorAll("#assetTable tbody tr").forEach(r=>{
        const dateStr=r.children[8].textContent.trim();
    const asset=r.children[1].textContent.trim();
    const freq=r.children[7].textContent.trim();
    if(dateStr&&asset){
      let d=new Date(dateStr);
      if(isNaN(d)){
        const p=dateStr.split("/");
        if(p.length===3) d=new Date(p[2],p[1]-1,p[0]);
      }
      const key=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate();
      if(!map[key]) map[key]=[];
      map[key].push({asset,freq});
    }
  });

  let html='<div class="cal-grid">';
  for(let i=0;i<startDay;i++) html+='<div></div>';

  for(let d=1;d<=days;d++){
    const key=y+"-"+(m+1)+"-"+d;
    const list=map[key]||[];
    // hadkan 10 sahaja, selebihnya guna see more
    const max=10;
    let notes=list.slice(0,max).map(x=>`<div><span class="dot w-${x.freq}"></span>${x.asset}</div>`).join("");
    if(list.length>max){
      notes+=`<div style="color:#888">+${list.length-max} lagi (see more)</div>`;
    }
    const safe=encodeURIComponent(JSON.stringify(list));
    html+=`<div class="day" data-list="${safe}"><b>${d}</b><div class="note">${notes}</div></div>`;
  }

  html+='</div>';
  const cal=document.getElementById("calendar");
  if(cal){
    cal.innerHTML=html;
    // bind click selepas render supaya tiada error HTML quoting
    cal.querySelectorAll('.day').forEach(el=>{
      const raw=el.getAttribute('data-list');
      const list=raw?JSON.parse(decodeURIComponent(raw)):[];

      // click = popup kecil
      el.onclick=()=>showDay(list);

      // hover = soft tooltip
      el.onmousemove=(ev)=>{
        if(!list.length) return;
        const t=document.getElementById('tooltip');
        t.style.display='block';
        t.style.left=(ev.pageX+10)+'px';
        t.style.top=(ev.pageY+10)+'px';
        t.textContent=list.map(x=>x.asset).join("\n");
      };
      el.onmouseleave=()=>{
        const t=document.getElementById('tooltip');
        t.style.display='none';
      };
    });
  }
}

function showDay(list){
  if(!list.length){alert("No asset scheduled today");return;}

  const wrap=document.createElement('div');
  wrap.className='miniPopupWrap';
  wrap.innerHTML=`<div class="miniPopup">
      <h4>Asset List</h4>
      ${list.map(x=>`<div>• ${x.asset} (${x.freq})</div>`).join('')}
      <button onclick="this.closest('.miniPopupWrap').remove()">Close</button>
    </div>`;
  document.body.appendChild(wrap);
}
</script>

</body>
</html>
