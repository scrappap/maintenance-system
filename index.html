
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Maintenance Schedule</title>
<link rel="icon" type="image/png" href="img/JKB logo.png">

<style>
body{margin:0;font-family:'Segoe UI',Arial,sans-serif;background:#0b1118;color:#cfefff}
body::before{content:"";position:fixed;inset:0;background-image:linear-gradient(rgba(0,255,255,.04) 1px, transparent 1px),linear-gradient(90deg, rgba(0,255,255,.04) 1px, transparent 1px);background-size:40px 40px;pointer-events:none}
.card{background:#121c26;border:1px solid #00e5ff33;border-radius:14px;box-shadow:0 0 20px rgba(0,255,255,.05)}
.headerBar{background:#0f1822;border:1px solid #00e5ff33;border-radius:14px;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.title{font-size:18px;font-weight:600;color:#00e5ff;letter-spacing:1px}
.subtle{font-size:11px;color:#ffaa00}
.btn{border:1px solid #00e5ff55;background:#111a24;color:#00e5ff;padding:6px 12px;font-size:12px;border-radius:6px;cursor:pointer;transition:.2s}
.btn:hover{background:#00e5ff22;box-shadow:0 0 8px #00e5ff}
.btn-danger{border-color:#ff3b3b;color:#ff3b3b}
.btn-green{border-color:#00ffaa;color:#00ffaa}
.btn-gray{border-color:#888;color:#aaa}
.btn-amber{border-color:#ffaa00;color:#ffaa00}
.kpiWrap{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin:15px 0}
.kpi{background:#111a24;border:1px solid #00e5ff33;border-radius:10px;padding:12px;text-align:center}
.kpi h4{font-size:11px;margin:0;color:#ffaa00}
.kpi div{font-size:20px;font-weight:700;color:#00e5ff;margin-top:6px}
table{width:100%;border-collapse:collapse}
th{background:#081018;color:#00e5ff;font-size:11px;text-transform:uppercase;border-bottom:1px solid #00e5ff55;position:sticky;top:0}
th,td{padding:8px 10px;font-size:12px;border-bottom:1px solid #1e2b36}
tr:hover{background:#00e5ff11}
.hasRemark{background:#003c2f!important}
.remarkText{color:#00ffaa;font-weight:600}
td.remarkText::before{content:"‚úî ";color:#00ffaa;font-weight:bold;}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.day{border:1px solid #00e5ff33;padding:6px;border-radius:6px;font-size:11px;background:#101822;min-height:70px;cursor:pointer}
.day b{color:#ffaa00}
.day:hover{box-shadow:0 0 8px #00e5ff}
input,select{background:#0f1822;border:1px solid #00e5ff33;color:#00e5ff;border-radius:6px;padding:5px}
.toast{position:fixed;top:20px;right:20px;background:#ff3b3b;color:white;padding:10px 16px;border-radius:8px;display:none;z-index:9999}
#comingModal{
  animation: fadeIn 0.25s ease-in-out;
}

@keyframes fadeIn{
  from{opacity:0}
  to{opacity:1}
}

  .calendar-wrapper{
  position:relative;
  overflow:hidden;
}

.calendar-slide{
  animation-duration:0.35s;
  animation-fill-mode:forwards;
}

.slide-left{
  animation-name:slideLeft;
}

.slide-right{
  animation-name:slideRight;
}

@keyframes slideLeft{
  from{transform:translateX(40px);opacity:0;}
  to{transform:translateX(0);opacity:1;}
}

@keyframes slideRight{
  from{transform:translateX(-40px);opacity:0;}
  to{transform:translateX(0);opacity:1;}
}
  
</style>
</head>
<body>

<div style="padding:25px">

  <!-- ================= LOGIN ================= -->
  <div id="loginPage" style="display:flex;justify-content:center;align-items:center;height:90vh">
    <div class="card" style="width:320px;padding:25px;text-align:center">
      <h2 style="color:#00e5ff;margin-bottom:20px">Login</h2>
      <input type="text" id="loginUser" placeholder="Username" style="width:100%;margin-bottom:10px">
      <input type="password" id="loginPass" placeholder="Password" style="width:100%;margin-bottom:15px">
      <button class="btn btn-green" style="width:100%" onclick="login()">Login</button>
      <div id="loginError" style="color:#ff3b3b;margin-top:10px;font-size:12px"></div>
    </div>
  </div>

  <!-- ================= DASHBOARD ================= -->
  <div id="homePage" style="display:none">

    <h2 style="color:#00e5ff">Dashboard</h2>

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-top:20px">

      <div onclick="openSystem()" class="card"
           style="cursor:pointer;padding:20px;text-align:center;
                  display:flex;flex-direction:column;align-items:center;justify-content:center;">
        <img src="img/UEM.jpg" style="height:70px;object-fit:contain;margin-bottom:10px">
        <div style="color:#00e5ff;font-weight:600">Asset by Edgenta</div>
      </div>

      <div onclick="openJKBSystem()" class="card"
           style="cursor:pointer;padding:20px;text-align:center;
                  display:flex;flex-direction:column;align-items:center;justify-content:center;">
        <img src="img/JKB logo.png" style="height:70px;object-fit:contain;margin-bottom:10px">
        <div style="color:#00e5ff;font-weight:600">Asset by JKB</div>
      </div>

    </div>
  </div>

  <!-- ================= EDGENTA SYSTEM ================= -->
  <div id="mainSystem" style="display:none;margin-top:20px">

    <div class="headerBar">
      <button class="btn btn-amber" onclick="openDashboard()">Dashboard</button>
      <div>
        <button class="btn btn-gray" id="roleBtn">Role: admin</button>
        <button class="btn btn-danger" onclick="logout()">Logout</button>
        <select id="yearSelect" onchange="changeYear(this.value)"></select>
      </div>
      <div>
        <div class="title">Preventive Maintenance</div>
        <div class="subtle">Asset Management</div>
      </div>
    </div>

    <!-- KPI -->
    <div class="kpiWrap">
      <div class="kpi">
        <h4>TOTAL (<span id="kpiYearLabel"></span>)</h4>
        <div id="kpiTotal">0</div>
      </div>
      <div class="kpi">
        <h4>DONE (<span id="kpiYearLabel2"></span>)</h4>
        <div id="kpiDone">0</div>
      </div>
      <div class="kpi">
        <h4>PENDING (<span id="kpiYearLabel3"></span>)</h4>
        <div id="kpiPending">0</div>
      </div>
      <div class="kpi">
        <h4>THIS MONTH</h4>
        <div id="kpiMonth">0</div>
      </div>
    </div>

    <!-- TABLE -->
    <div class="card" style="max-height:420px;overflow:auto">
      <table id="assetTable">
        <thead>
          <tr>
            <th><input type="checkbox" onclick="toggleSelectAll(this.checked)"></th>
            <th>ASSET NO</th>
            <th>TYPE CODE</th>
            <th>ASSET DESCRIPTION</th>
            <th>DISCIPLINE</th>
            <th>CODE LOCATION</th>
            <th>LOCATION</th>
            <th>FREQUENCY</th>
            <th>TARGET DATE</th>
            <th>REMARK</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <!-- ================= JKB SYSTEM ================= -->
  <div id="jkbSystem" style="display:none;margin-top:20px">

    <div class="headerBar">
      <button class="btn btn-amber" onclick="openDashboard()">Dashboard</button>
      <div>
        <button class="btn btn-gray" id="roleBtnJKB">Role: admin</button>
        <button class="btn btn-danger" onclick="logout()">Logout</button>
      </div>
      <div>
        <div class="title">Warranty Monitoring</div>
        <div class="subtle">Asset by JKB</div>
      </div>
    </div>

    <div class="kpiWrap">
      <div class="kpi">
        <h4>Warranty Active</h4>
        <div id="jkbActive">0</div>
      </div>
      <div class="kpi">
        <h4>Expiring &lt; 90 Days</h4>
        <div id="jkbExpiring">0</div>
      </div>
      <div class="kpi">
        <h4>PPM Due 30 Days</h4>
        <div id="jkbDue">0</div>
      </div>
      <div class="kpi">
        <h4>PPM Overdue</h4>
        <div id="jkbOverdue">0</div>
      </div>
    </div>

    <div class="card" style="padding:12px;margin-bottom:12px">
      <button class="btn btn-green" onclick="exportVendorReminder()">
        Export 30 Days Reminder
      </button>
    </div>

    <div class="card" style="max-height:420px;overflow:auto">
      <table id="jkbPPMTable">
        <thead>
          <tr>
            <th>ASSET NO</th>
            <th>VENDOR</th>
            <th>PLANNED DATE</th>
            <th>ONSITE DATE</th>
            <th>STATUS</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card" style="padding:15px;margin-top:15px">
      <canvas id="vendorChart" height="90"></canvas>
    </div>

  </div>

</div>

<div class="toast" id="toast"></div>
  
<!-- IMPORT PREVIEW MODAL -->
<div id="importPreviewModal" style="
display:none;
position:fixed;
inset:0;
background:rgba(0,0,0,0.8);
justify-content:center;
align-items:center;
z-index:9999;
">

  <div style="
  background:#121c26;
  border:1px solid #00e5ff;
  padding:20px;
  border-radius:12px;
  width:90%;
  max-height:80vh;
  overflow:auto;
  ">

    <h3 style="color:#00e5ff">Import Preview</h3>

    <table id="previewTable" style="width:100%;margin-top:10px;border-collapse:collapse"></table>

    <div style="margin-top:15px;text-align:right">
      <button class="btn btn-gray" onclick="closeImportPreview()">Cancel</button>
      <button class="btn btn-green" onclick="confirmImport()">Confirm Import</button>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

const STORAGE_KEY='assetData';

const SESSION_KEY='pm_user_session';

let currentRole='admin';

let selectedYear=new Date().getFullYear();

let viewDate=new Date();

let yearChartInstance = null;

let generationLocked = false;

let importPreviewData = [];

let globalAssets = [];

let selectedCalendarDate = null;
  
/*================================
   API
   =============================*/
   
   const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbwAJl-cEwnDnQpeSQAruRe4eeaH-BO9PTfTW2q-JZ5sXIF7p2m0usnj2IPoBdktdf7B4A/exec";

function sendToSheet(params){
    params.year = selectedYear;
  return fetch(SHEET_API_URL, {
    method: "POST",
    body: new URLSearchParams(params)
  });
}

const JKB_API_URL = "https://script.google.com/macros/s/AKfycbwClplX-V7w5xN7BPV4iuU-GdDgb3Dv-tNBcpWW8eo5MrbA5nEedoGpx9Prl-O9WfQ5-Q/exec";

let jkbAssets = [];
let jkbPPM = [];
let vendorChartInstance = null;

function loadJKBData(){
fetch(JKB_API_URL + "?action=getAll")
.then(res=>res.json())
.then(data=>{
    jkbAssets = data.assets;
    jkbPPM = data.ppm;
    renderJKB();
    renderVendorChart();
});
}
  
function formatDate(dateString){

  if(!dateString) return "";

  const date = new Date(dateString);

  return date.toLocaleDateString("en-GB"); 
  // Format: DD/MM/YYYY
}
  
function toISO(date){
  const d = new Date(date);
  return d.toISOString().split("T")[0];
}

function normalizeDate(value){

  if(!value) return null;

  // Jika nombor Excel serial
  if(!isNaN(value)){
    const date = new Date((value - 25569) * 86400 * 1000);
    return date.toISOString().split("T")[0];
  }

  // Cuba parse biasa
  const d = new Date(value);

  if(!isNaN(d)){
    return d.toISOString().split("T")[0];
  }

  return null;
}


/* ===============================
   INIT
================================ */
window.addEventListener('DOMContentLoaded',()=>{

  const session = JSON.parse(localStorage.getItem(SESSION_KEY));

  if(session){
    currentRole = session.role;
    document.getElementById('loginPage').style.display='none';
    document.getElementById('homePage').style.display='block';
    setRole(currentRole);
  }else{
    document.getElementById('loginPage').style.display='flex';
  }

  document.getElementById('excelFile')
    .addEventListener('change', handleImport);
});


/* ===============================
   MODULE CONTROLLER (UNIFIED)
================================ */

function hideAllModules(){

    const home = document.getElementById('homePage');
    const main = document.getElementById('mainSystem');
    const jkb  = document.getElementById('jkbSystem');

    if(home) home.style.display='none';
    if(main) main.style.display='none';
    if(jkb)  jkb.style.display='none';
}

function openDashboard(){
    hideAllModules();
    document.getElementById('homePage').style.display='block';
}

function openSystem(){
    hideAllModules();
    document.getElementById('mainSystem').style.display='block';
}

function openJKBSystem(){
    hideAllModules();
    document.getElementById('jkbSystem').style.display='block';
}

/*===============================
  AUTOLOAD GOOGLE SHEET
  =============================*/
  
let localCache = null;

function loadFromGoogleSheet(){

  fetch(SHEET_API_URL + "?year=" + selectedYear)
    .then(res => res.json())
    .then(data => {

      localCache = data;

      // ‚úÖ filter ikut tahun (kalau perlu)
      globalAssets = data.filter(a=>{
        if(!a.startDate) return false;
        return new Date(a.startDate).getFullYear() === selectedYear;
      });

      populateFilters();

      const tbody = document.querySelector('#assetTable tbody');
      tbody.innerHTML = '';

      globalAssets.forEach(asset => {

        const tr = tbody.insertRow();
        tr.dataset.id = asset.id;

        tr.insertCell().innerHTML =
          '<input type="checkbox" class="rowCheck">';

        const assetCell = tr.insertCell();

assetCell.innerHTML = `
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <span>${asset.assetNo || "-"}</span>
    <button onclick="goToDetail('${asset.assetNo || ""}')" 
      style="
        background:none;
        border:none;
        color:#00e5ff;
        cursor:pointer;
        font-size:14px;
      ">
      üëÅ
    </button>
  </div>
`;

        tr.insertCell().innerText = asset.typeCode || '';
        tr.insertCell().innerText = asset.description || '';
        tr.insertCell().innerText = asset.discipline || '';
        tr.insertCell().innerText = asset.codeLocation || '';
        tr.insertCell().innerText = asset.location || '';
        tr.insertCell().innerText = asset.frequency || '';
        tr.insertCell().innerText = formatDate(asset.startDate);

        const remarkCell = tr.insertCell();
        remarkCell.contentEditable = true;
        remarkCell.innerText = asset.remark || '';

        remarkCell.addEventListener('blur',()=>{
          sendToSheet({
            action:"update",
            year:selectedYear,
            id:asset.id,
            remark:remarkCell.innerText
          });
        });

      });

      renderCalendar();
      updateKPI();
      renderYearChart();
      autoGenerateNextYear();

    })
    .catch(err=>{
      console.error("Load error:", err);
    });

}

function goToDetail(assetNo){
  console.log("Clicked Asset:", assetNo);
  window.location.href = "asset-detail.html?asset=" + encodeURIComponent(assetNo);
}

function openJKB(){
    window.location.href = "asset-jkb.html";
}
  
/*===============================
  AUTOGENERATE NEXT YEAR
  =============================*/
  
function autoGenerateNextYear(){

if(generationLocked) return;
generationLocked = true;

  const now = new Date();
  const currentMonth = now.getMonth(); // 0-11
  const currentDate = now.getDate();
  const currentYear = now.getFullYear();

  // ‚úÖ HANYA 31 DISEMBER SAHAJA
  if(currentMonth !== 11 || currentDate !== 31){
    return;
  }

  const nextYear = currentYear + 1;

  console.log("Checking auto generation for:", nextYear);

  globalAssets.forEach(asset=>{

    if(!asset.startDate) return;

    const freqWeeks = getWeeksFromFrequency(asset.frequency);
    if(freqWeeks === 0) return;

    // ‚úÖ CHECK DUPLICATE PER ASSET
    const alreadyExist = globalAssets.some(a=>{
      if(!a.startDate) return false;

      const d = new Date(a.startDate);

      return (
        a.assetNo === asset.assetNo &&
        d.getFullYear() === nextYear
      );
    });

    if(alreadyExist){
      return;
    }

    let newDate = new Date(asset.startDate);
    newDate.setFullYear(nextYear);

sendToSheet({
  action:"create",
  assetNo:asset.assetNo,
  typeCode:asset.typeCode,
  description:asset.description,
  discipline:asset.discipline,
  codeLocation:asset.codeLocation,
  location:asset.location,
  frequency:asset.frequency,
  startDate:newDate.toLocaleDateString(),
  durationYears:"5",
  remark:""
});
  });

  showToast("Schedule "+nextYear+" auto generated");
}

/* ===============================
   YEAR DROPDOWN
================================ */
function initYear(){
  const yearSelect=document.getElementById('yearSelect');
  yearSelect.innerHTML='';
  const thisYear=new Date().getFullYear();

  for(let y=thisYear-2;y<=thisYear+3;y++){
    const opt=document.createElement('option');
    opt.value=y;
    opt.textContent=y;
    if(y===selectedYear) opt.selected=true;
    yearSelect.appendChild(opt);
  }
}

function changeYear(y){
  selectedYear=parseInt(y);
  viewDate.setFullYear(selectedYear);
  loadFromGoogleSheet();   // ‚úÖ reload data from Sheet
}

function prevMonth(){

  let month = viewDate.getMonth();
  let year = viewDate.getFullYear();

  month--;
  if(month < 0){
    month = 11;
    year--;
  }

  viewDate = new Date(year, month, 1);

  animateCalendar("right");
}

function nextMonth(){

  let month = viewDate.getMonth();
  let year = viewDate.getFullYear();

  month++;
  if(month > 11){
    month = 0;
    year++;
  }

  viewDate = new Date(year, month, 1);

  animateCalendar("left");
}

function animateCalendar(direction){

  const calendar = document.getElementById("calendar");

  calendar.classList.remove("slide-left","slide-right");

  void calendar.offsetWidth; // force reflow

  if(direction === "left"){
    calendar.classList.add("calendar-slide","slide-left");
  }else{
    calendar.classList.add("calendar-slide","slide-right");
  }

  renderCalendar();
  updateKPI();
}
  
/* ===============================
   RENDER YEAR CHART
================================ */

function renderYearChart(){

  const monthlyCount = new Array(12).fill(0);

  globalAssets.forEach(a=>{
    if(!a.startDate) return;
    const d = new Date(a.isoDate);
    if(d.getFullYear() === selectedYear){
      monthlyCount[d.getMonth()]++;
    }
  });

  if(yearChartInstance){
    yearChartInstance.destroy();
  }

  yearChartInstance = new Chart(
    document.getElementById("yearChart"),
    {
      type:"bar",
      data:{
        labels:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
        datasets:[{
          label:"Maintenance Count",
          data:monthlyCount
        }]
      }
    }
  );
}

/* ===============================
   CALENDAR FULL GRID
================================ */
function renderCalendar(){

  const calendar = document.getElementById('calendar');
  calendar.innerHTML = '';

  const year = viewDate.getFullYear();
  const month = viewDate.getMonth();

  const firstDay = new Date(year,month,1).getDay();
  const daysInMonth = new Date(year,month+1,0).getDate();

  document.getElementById('monthLabel').textContent =
    viewDate.toLocaleString('en-GB',{month:'long',year:'numeric'});

  const grid = document.createElement('div');
  grid.className = 'cal-grid';

  for(let i=0;i<firstDay;i++){
    grid.appendChild(document.createElement('div'));
  }

  for(let dayNum=1; dayNum<=daysInMonth; dayNum++){

    const day = document.createElement('div');
    day.className = 'day';
    day.innerHTML = '<b>'+dayNum+'</b>';

    const compareISO = new Date(year,month,dayNum)
      .toISOString()
      .split("T")[0];

    const match = globalAssets.filter(a => 
      a.isoDate === compareISO
    );

    if(match.length > 0){
      day.style.background = '#003c2f';
      day.innerHTML += 
        '<div style="color:#00ffaa;font-size:10px">'
        + match.length + ' Asset</div>';
    }

    day.onclick = function(){
      filterTableByDate(compareISO);
    };

    grid.appendChild(day);
  }

  calendar.appendChild(grid);
}

function filterTableByDate(selectedDate){

  const filtered = globalAssets.filter(a=>{
    if(!a.startDate) return false;
    return toISO(a.startDate) === selectedDate;
  });

  const tbody = document.querySelector('#assetTable tbody');
  tbody.innerHTML = "";

  filtered.forEach(asset=>{

    const tr = tbody.insertRow();
    tr.dataset.id = asset.id;

    tr.insertCell().innerHTML =
      '<input type="checkbox" class="rowCheck">';

    const assetCell = tr.insertCell();
    assetCell.innerHTML = `
      <div style="display:flex;justify-content:space-between;">
        <span>${asset.assetNo}</span>
        <button onclick="goToDetail('${asset.assetNo}')" 
          style="background:none;border:none;color:#00e5ff;cursor:pointer">
          üëÅ
        </button>
      </div>
    `;

    tr.insertCell().innerText = asset.typeCode;
    tr.insertCell().innerText = asset.description;
    tr.insertCell().innerText = asset.discipline;
    tr.insertCell().innerText = asset.codeLocation;
    tr.insertCell().innerText = asset.location;
    tr.insertCell().innerText = asset.frequency;
    tr.insertCell().innerText = formatDate(asset.startDate);

    const remarkCell = tr.insertCell();
    remarkCell.contentEditable = true;
    remarkCell.innerText = asset.remark || '';

  });

  showToast(filtered.length + " asset found");
}
  
function resetTableFilter(){

  const rows = document.querySelectorAll('#assetTable tbody tr');

  rows.forEach(r=>{
    r.style.display = "";
    r.style.background = "";
  });

  showToast("Filter cleared");
}


  
/*================================
  POPULATE FILTER
  ==============================*/
  
  function populateFilters(){

  const disciplineSet = new Set();
  const locationSet = new Set();

  globalAssets.forEach(a=>{
    if(a.discipline) disciplineSet.add(a.discipline);
    if(a.location) locationSet.add(a.location);
  });

  const disciplineSelect = document.getElementById("filterDiscipline");
  const locationSelect = document.getElementById("filterLocation");

  disciplineSelect.innerHTML = '<option value="">All Discipline</option>';
  locationSelect.innerHTML = '<option value="">All Location</option>';

  disciplineSet.forEach(d=>{
    disciplineSelect.innerHTML += `<option value="${d}">${d}</option>`;
  });

  locationSet.forEach(l=>{
    locationSelect.innerHTML += `<option value="${l}">${l}</option>`;
  });
}

/* ===============================
   APPLY FILTER
================================ */

function applyFilters(){

  const discipline = document.getElementById("filterDiscipline").value;
  const location = document.getElementById("filterLocation").value;

  const rows = document.querySelectorAll("#assetTable tbody tr");

  rows.forEach(r=>{
    const rDis = r.children[4].innerText;
    const rLoc = r.children[6].innerText;

    let show = true;

    if(discipline && rDis !== discipline) show = false;
    if(location && rLoc !== location) show = false;

    r.style.display = show ? "" : "none";
  });
}

/* ===============================
   DAY DETAIL
================================ */
function showDayDetail(day){

  const card=document.getElementById('dayDetailCard');
  const content=document.getElementById('dayDetailContent');

  const year=viewDate.getFullYear();
  const month=viewDate.getMonth();

  const selectedDate=new Date(year,month,day).toLocaleDateString();

  const rows=[...document.querySelectorAll('#assetTable tbody tr')];

  const filtered=rows.filter(r=>{
    const date=r.children[8].innerText;
    if(!date) return false;
    return new Date(date).toLocaleDateString()===selectedDate;
  });

  if(filtered.length===0){
    content.innerHTML='Tiada asset pada tarikh ini';
  }else{
    content.innerHTML=filtered.map(r=>{
      const asset=r.children[1].innerText;
      const desc=r.children[3].innerText;
      const remark=r.children[9].innerText;

      const status=remark.trim() ? 
        '<span style="color:#00ffaa">DONE</span>' :
        '<span style="color:#ff3b3b">PENDING</span>';

      return `
        <div style="margin-bottom:8px;border-bottom:1px solid #1e2b36;padding-bottom:5px">
          <b>${asset}</b> - ${desc}<br>
          Status: ${status}
        </div>
      `;
    }).join('');
  }

  card.style.display='block';
}

/*================================
   WEEK FUNCTIONs
   =============================*/
function getWeeksFromFrequency(freq){

  if(!freq) return 0;

  freq = freq.toLowerCase();

  if(freq.includes('monthly')) return 4;
  if(freq.includes('quarterly')) return 12;
  if(freq.includes('semi')) return 26;
  if(freq.includes('annual')) return 52;

  return 0;
}

/* ===============================
   TABLE FUNCTIONS
================================ */
function addRow(){

  const assetNo = prompt("Asset No?");
  if(!assetNo) return;

  // ‚úÖ CHECK DUPLICATE DULU
  if(globalAssets.some(a=>a.assetNo === assetNo)){
    showToast("Asset already exists!");
    return;
  }

  const data = {
    action:"create",
    assetNo:assetNo,
    typeCode:"",
    description:"",
    discipline:"",
    codeLocation:"",
    location:"",
    frequency:"Monthly",
    startDate:new Date().toLocaleDateString(),
    remark:""
  };

sendToSheet({
  action:"create",
  assetNo:assetNo,
  typeCode:"",
  description:"",
  discipline:"",
  codeLocation:"",
  location:"",
  frequency:"Monthly",
  startDate:new Date().toLocaleDateString(),
  durationYears:"5",
  remark:""
}).then(()=>loadFromGoogleSheet());
}

function deleteSelected(){

  const selected = document.querySelectorAll('.rowCheck:checked');

  selected.forEach(cb=>{

    const tr = cb.closest('tr');
    const id = tr.dataset.id;

sendToSheet({
  action:"delete",
  id:id
});

  });

  setTimeout(loadFromGoogleSheet,500);
}

function toggleSelectAll(checked){
  document.querySelectorAll('.rowCheck')
    .forEach(cb=>cb.checked=checked);
}

function searchTable(){
  const value=document.getElementById('searchBox')
    .value.toLowerCase();

  document.querySelectorAll('#assetTable tbody tr')
    .forEach(row=>{
      row.style.display=row.innerText.toLowerCase()
        .includes(value)?'':'none';
    });
}

/*==============================
  RESHEDULE FUNCTIONS
  ============================*/
  
function rescheduleSelected(){

  if(currentRole === 'viewer'){
    showToast('Viewer tidak dibenarkan reschedule');
    return;
  }

  const selected=document.querySelectorAll('.rowCheck:checked');

  if(selected.length===0){
    showToast('Pilih asset dahulu');
    return;
  }

  selected.forEach(cb=>{

    const tr=cb.closest('tr');
    const id = tr.dataset.id;

    const freq=tr.children[7].innerText;
    const dateCell=tr.children[8];

    if(!dateCell.innerText) return;

    const weeks=getWeeksFromFrequency(freq);
    if(weeks===0) return;

    const currentDate=new Date(dateCell.innerText);
    currentDate.setDate(currentDate.getDate() + (weeks * 7));

    sendToSheet({
      action:"update",
      id:id,
      startDate: currentDate.toLocaleDateString(),
      remark:""
    });

  });

  setTimeout(loadFromGoogleSheet,500);
  showToast('Next schedule generated');
}

/* ===============================
   SAVE / LOAD
================================ */

function saveTable(){

  const rows = [...document.querySelectorAll('#assetTable tbody tr')];

  rows.forEach(r=>{

    const rowData = {
      assetNo: r.children[1].innerText,
      typeCode: r.children[2].innerText,
      description: r.children[3].innerText,
      discipline: r.children[4].innerText,
      codeLocation: r.children[5].innerText,
      location: r.children[6].innerText,
      frequency: r.children[7].innerText,
      startDate: r.children[8].innerText,
      durationYears: 5,
      remark: r.children[9].innerText
    };

    sendToSheet(rowData);

  });

  showToast("Data dihantar ke Google Sheet");
}
/*==========================
  UPDATE KPI FUNCTIONS
  ========================*/
  
function updateKPI(){

  const selectedYearValue = selectedYear;
  const currentMonth = viewDate.getMonth();

  let totalYear = 0;
  let doneYear = 0;
  let monthCount = 0;

  globalAssets.forEach(r=>{

    if(!r.startDate) return;

    const d=new Date(r.startDate);

    if(d.getFullYear() === selectedYearValue){

      totalYear++;

      if(r.remark && r.remark.trim()) doneYear++;

      if(d.getMonth() === currentMonth){
        monthCount++;
      }
    }

  });

  document.getElementById('kpiYearLabel').innerText = selectedYearValue;
  document.getElementById('kpiYearLabel2').innerText = selectedYearValue;
  document.getElementById('kpiYearLabel3').innerText = selectedYearValue;

  document.getElementById('kpiTotal').innerText = totalYear;
  document.getElementById('kpiDone').innerText = doneYear;
  document.getElementById('kpiPending').innerText = totalYear - doneYear;
  document.getElementById('kpiMonth').innerText = monthCount;
}

function applyRemarkStyle(row,cell){
  if(!cell) return;

  if(cell.textContent.trim()){
    row.classList.add('hasRemark');
    cell.classList.add('remarkText');
  }else{
    row.classList.remove('hasRemark');
    cell.classList.remove('remarkText');
  }
}


/* ===============================
   IMPORT EXCEL (STABLE)
================================ */

function handleImport(e){

  const file = e.target.files[0];

  if(!file){
    showToast("Tiada file dipilih");
    return;
  }

  const reader = new FileReader();

  reader.onload = function(evt){

    try{

      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data,{type:'array'});
      const worksheet = workbook.Sheets[workbook.SheetNames[0]];

      const rows = XLSX.utils.sheet_to_json(worksheet,{header:1});

      if(rows.length <= 1){
        showToast("File kosong atau format salah");
        return;
      }

      // buang header row
      importPreviewData = rows.slice(1);

      renderImportPreview(importPreviewData);

      document.getElementById("importPreviewModal").style.display="flex";

    }catch(err){
      console.error(err);
      showToast("Format file tidak sah");
    }

  };

  reader.readAsArrayBuffer(file);
  e.target.value='';
}

function renderImportPreview(data){

  const table = document.getElementById("previewTable");
  table.innerHTML = "";

  table.innerHTML += `
    <tr style="background:#081018;color:#00e5ff">
      <th>ASSET NO</th>
      <th>TYPE CODE</th>
      <th>DESCRIPTION</th>
      <th>DISCIPLINE</th>
      <th>LOCATION</th>
      <th>START DATE</th>
    </tr>
  `;

  data.slice(0,20).forEach(row=>{

    table.innerHTML += `
      <tr style="border-bottom:1px solid #1e2b36">
        <td>${row[0]||''}</td>
        <td>${row[1]||''}</td>
        <td>${row[2]||''}</td>
        <td>${row[3]||''}</td>
        <td>${row[5]||''}</td>
        <td>${row[7]||''}</td>
      </tr>
    `;
  });
}

async function confirmImport(){

  if(importPreviewData.length === 0){
    showToast("Tiada data untuk import");
    return;
  }

  const chunkSize = 25;
  let index = 0;

  while(index < importPreviewData.length){

    const chunk = importPreviewData.slice(index, index + chunkSize);

    const bulkData = chunk.map(row => ({
      assetNo: row[0] || "",
      typeCode: row[1] || "",
      description: row[2] || "",
      discipline: row[3] || "",
      codeLocation: row[4] || "",
      location: row[5] || "",
      frequency: row[6] || "",
      startDate: convertExcelDate(row[7]),
      durationYears: row[8] || "",
      remark: row[9] || ""
    }));

    await fetch(SHEET_API_URL, {
      method: "POST",
      body: new URLSearchParams({
        action: "bulkCreate",
        data: JSON.stringify(bulkData)
      })
    });

    index += chunkSize;

    showToast("Imported " + index + " / " + importPreviewData.length);

    await new Promise(r => setTimeout(r, 1000));
  }

  showToast("Import selesai");
  closeImportPreview();
  loadFromGoogleSheet();
}
  
function closeImportPreview(){
  document.getElementById("importPreviewModal").style.display="none";
  importPreviewData = [];
}

function triggerImport(){
  document.getElementById('excelFile').click();
}

function convertExcelDate(value){
  if(typeof value === "number"){
    const date = new Date((value - 25569) * 86400 * 1000);
    return date.toLocaleDateString();
  }
  return value || "";
}
  
/*=========================================
  EXPORT
=========================================*/

async function exportExcel(){

  try{

    // üî• Ambil maintenance data
    const maintenanceRes = await fetch(
      SHEET_API_URL + "?year=" + selectedYear
    );
    const maintenanceData = await maintenanceRes.json();

    // üî• Ambil asset master data
    const masterRes = await fetch(
      SHEET_API_URL + "?action=getAssetMaster"
    );
    const masterData = await masterRes.json();

    // Convert master jadi object lookup
    const masterMap = {};
    masterData.forEach(m=>{
      masterMap[m.assetNo] = m;
    });

    // Header gabungan
    const header = [
      "Asset No",
      "Type Code",
      "Description",
      "Discipline",
      "Location",
      "Frequency",
      "Target Date",
      "Remark",
      "Vendor",
      "Brand",
      "Model",
      "Serial Number",
      "Price"
    ];

    const rows = maintenanceData.map(m=>{

      const detail = masterMap[m.assetNo] || {};

      return [
        m.assetNo || "",
        m.typeCode || "",
        m.description || "",
        m.discipline || "",
        m.location || "",
        m.frequency || "",
        m.startDate || "",
        m.remark || "",
        detail.vendor || "",
        detail.brand || "",
        detail.model || "",
        detail.serialNumber || "",
        detail.price || ""
      ];
    });

    const ws = XLSX.utils.aoa_to_sheet([header, ...rows]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Combined");

    XLSX.writeFile(wb, "Maintenance_Combined_"+selectedYear+".xlsx");

    showToast("Combined export successful");

  }catch(err){
    console.error(err);
    showToast("Export error");
  }
}
/*=========================================
LOGIN/LOGOUT
=========================================*/
const USERS = {
  admin: { password: "admin123", role: "admin" },
  viewer: { password: "JKB123", role: "viewer" }
};

function login(){

  const user=document.getElementById('loginUser').value.trim();
  const pass=document.getElementById('loginPass').value.trim();
  const error=document.getElementById('loginError');

  if(!USERS[user] || USERS[user].password !== pass){
    error.innerText="Username or password incorrect";
    return;
  }

  currentRole=USERS[user].role;

  // Save session
  localStorage.setItem(SESSION_KEY, JSON.stringify({
    username:user,
    role:currentRole
  }));

  document.getElementById('loginPage').style.display='none';
  document.getElementById('homePage').style.display='block';

  setRole(currentRole);
}
function logout(){

  localStorage.removeItem(SESSION_KEY);

  currentRole='admin';

  document.getElementById('mainSystem').style.display='none';
  document.getElementById('homePage').style.display='none';
  document.getElementById('loginPage').style.display='flex';

location.reload();

}

function setRole(role){

  currentRole = role;

  const roleBtn = document.getElementById('roleBtn');
  if(roleBtn){
    roleBtn.innerText = 'Role: ' + role;
  }

  const isViewer = role === 'viewer';

  // üéØ Disable ONLY specific buttons

  const addBtn = document.querySelector('button[onclick="addRow()"]');
  const deleteBtn = document.querySelector('button[onclick="deleteSelected()"]');
  const rescheduleBtn = document.querySelector('button[onclick="rescheduleSelected()"]');
  const importBtn = document.querySelector('button[onclick="triggerImport()"]');

  if(addBtn) addBtn.style.display = isViewer ? 'none' : 'inline-block';
  if(deleteBtn) deleteBtn.style.display = isViewer ? 'none' : 'inline-block';
  if(rescheduleBtn) rescheduleBtn.style.display = isViewer ? 'none' : 'inline-block';
  if(importBtn) importBtn.style.display = isViewer ? 'none' : 'inline-block';
}

function comingSoon(){
  document.getElementById('comingModal').style.display='flex';
}

function closeComingModal(){
  document.getElementById('comingModal').style.display='none';
}

function showToast(message){

  const toast=document.getElementById('toast');
  toast.innerText=message;
  toast.style.display='block';

  setTimeout(()=>{
    toast.style.display='none';
  },3000);
}



</script>



</body>
</html>






































































