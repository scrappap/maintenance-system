<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Maintenance Schedule</title>
<link rel="icon" type="image/png" href="img/JKB logo.png">

<style>
body{margin:0;font-family:'Segoe UI',Arial,sans-serif;background:#0b1118;color:#cfefff}
body::before{content:"";position:fixed;inset:0;background-image:linear-gradient(rgba(0,255,255,.04) 1px, transparent 1px),linear-gradient(90deg, rgba(0,255,255,.04) 1px, transparent 1px);background-size:40px 40px;pointer-events:none}
.card{background:#121c26;border:1px solid #00e5ff33;border-radius:14px;box-shadow:0 0 20px rgba(0,255,255,.05)}
.headerBar{background:#0f1822;border:1px solid #00e5ff33;border-radius:14px;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.title{font-size:18px;font-weight:600;color:#00e5ff;letter-spacing:1px}
.subtle{font-size:11px;color:#ffaa00}
.btn{border:1px solid #00e5ff55;background:#111a24;color:#00e5ff;padding:6px 12px;font-size:12px;border-radius:6px;cursor:pointer;transition:.2s}
.btn:hover{background:#00e5ff22;box-shadow:0 0 8px #00e5ff}
.btn-danger{border-color:#ff3b3b;color:#ff3b3b}
.btn-green{border-color:#00ffaa;color:#00ffaa}
.btn-gray{border-color:#888;color:#aaa}
.btn-amber{border-color:#ffaa00;color:#ffaa00}
.kpiWrap{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin:15px 0}
.kpi{background:#111a24;border:1px solid #00e5ff33;border-radius:10px;padding:12px;text-align:center}
.kpi h4{font-size:11px;margin:0;color:#ffaa00}
.kpi div{font-size:20px;font-weight:700;color:#00e5ff;margin-top:6px}
table{width:100%;border-collapse:collapse}
th{background:#081018;color:#00e5ff;font-size:11px;text-transform:uppercase;border-bottom:1px solid #00e5ff55;position:sticky;top:0}
th,td{padding:8px 10px;font-size:12px;border-bottom:1px solid #1e2b36}
tr:hover{background:#00e5ff11}
.hasRemark{background:#003c2f!important}
.remarkText{color:#00ffaa;font-weight:600}
td.remarkText::before{content:"✔ ";color:#00ffaa;font-weight:bold;}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.day{border:1px solid #00e5ff33;padding:6px;border-radius:6px;font-size:11px;background:#101822;min-height:70px;cursor:pointer}
.day b{color:#ffaa00}
.day:hover{box-shadow:0 0 8px #00e5ff}
input,select{background:#0f1822;border:1px solid #00e5ff33;color:#00e5ff;border-radius:6px;padding:5px}
.toast{position:fixed;top:20px;right:20px;background:#ff3b3b;color:white;padding:10px 16px;border-radius:8px;display:none;z-index:9999}
</style>
</head>
<body>

<div style="padding:25px">

<div id="homePage">
  <h2 style="color:#00e5ff">Dashboard</h2>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-top:20px">
    <div onclick="openSystem()" class="card" style="cursor:pointer;padding:20px;text-align:center">
      <img src="img/UEM.jpg" style="height:70px;object-fit:contain">
      <div style="margin-top:10px;color:#00e5ff">Asset by Edgenta</div>
    </div>
    <div onclick="openSystem()" class="card" style="cursor:pointer;padding:20px;text-align:center">
      <img src="img/JKB logo.png" style="height:70px;object-fit:contain">
      <div style="margin-top:10px;color:#00e5ff">Asset by JKB</div>
    </div>
  </div>
</div>

<div id="mainSystem" style="display:none;margin-top:20px">

<div class="headerBar">
  <div>
    <button class="btn btn-amber" onclick="goDashboard()">Dashboard</button>
  </div>
  <div>
    <button class="btn btn-gray" id="roleBtn">Role: admin</button>
    <select id="yearSelect" onchange="changeYear(this.value)"></select>
  </div>
  <div>
    <div class="title">Preventive Maintenance</div>
    <div class="subtle">Asset Manage</div>
  </div>
</div>

<div class="kpiWrap">
  <div class="kpi"><h4>TOTAL</h4><div id="kpiTotal">0</div></div>
  <div class="kpi"><h4>DONE</h4><div id="kpiDone">0</div></div>
  <div class="kpi"><h4>PENDING</h4><div id="kpiPending">0</div></div>
  <div class="kpi"><h4>THIS MONTH</h4><div id="kpiMonth">0</div></div>
</div>

<div class="card" style="padding:12px;margin-bottom:12px;display:flex;flex-wrap:wrap;gap:8px">
  <button class="btn" onclick="addRow()">Add</button>
  <button class="btn btn-danger" onclick="deleteSelected()">Delete</button>
  <button class="btn btn-green" onclick="rescheduleSelected()">Reschedule</button>
  <button class="btn btn-amber" onclick="triggerImport()">Import</button>
  <button class="btn" onclick="exportExcel()">Export</button>
  <input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none">
  <input type="text" id="searchBox" onkeyup="searchTable()" placeholder="Search anything...">
</div>

<div style="text-align:center;margin-bottom:12px;">
  <button class="btn" onclick="prevMonth()">◀</button>
  <span id="monthLabel" style="margin:0 10px;color:#ffaa00"></span>
  <button class="btn" onclick="nextMonth()">▶</button>
</div>

<div class="card" style="padding:12px;margin-bottom:12px">
  <div style="margin-bottom:6px;color:#ffaa00">Monthly Schedule</div>
  <div id="calendar"></div>
</div>

<div class="card" style="padding:12px;margin-bottom:12px;display:none" id="dayDetailCard">
  <div style="margin-bottom:6px;color:#ffaa00">Selected Day Asset List</div>
  <div id="dayDetailContent"></div>
</div>

<div class="card" style="max-height:420px;overflow:auto">
<table id="assetTable">
<thead>
<tr>
<th><input type="checkbox" onclick="toggleSelectAll(this.checked)"></th>
<th>ASSET NO</th>
<th>TYPE CODE</th>
<th>ASSET DESCRIPTION</th>
<th>DISCIPLINE</th>
<th>CODE LOCATION</th>
<th>LOCATION</th>
<th>FREQUENCY</th>
<th>TARGET DATE</th>
<th>REMARK</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

</div>

<div class="toast" id="toast"></div>

</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
const STORAGE_KEY='assetData';
let currentRole='admin';
let selectedYear=new Date().getFullYear();
let viewDate=new Date();

function openSystem(){
  document.getElementById('homePage').style.display='none';
  document.getElementById('mainSystem').style.display='block';
  initYear();
  loadTable();
  renderCalendar();
  updateKPI();
}
window.openSystem=openSystem;

function goDashboard(){
  document.getElementById('mainSystem').style.display='none';
  document.getElementById('homePage').style.display='block';
}
window.goDashboard=goDashboard;

function setRole(role){
  currentRole=role;
  document.getElementById('roleBtn').innerText='Role: '+role;
  const isAdmin=(role==='admin');
  document.querySelector("button[onclick='addRow()']").style.display=isAdmin?'inline-block':'none';
  document.querySelector("button[onclick='deleteSelected()']").style.display=isAdmin?'inline-block':'none';
  document.querySelector("button[onclick='triggerImport()']").style.display=isAdmin?'inline-block':'none';
}

window.addEventListener('DOMContentLoaded',()=>{
  setRole('admin');
});

function initYear(){
  const sel=document.getElementById('yearSelect');
  sel.innerHTML='';
  const now=new Date().getFullYear();
  for(let y=now-3;y<=now+3;y++){
    const opt=document.createElement('option');
    opt.value=y; opt.textContent=y;
    if(y===selectedYear) opt.selected=true;
    sel.appendChild(opt);
  }
}

function changeYear(y){
  selectedYear=parseInt(y);
  loadTable();
  renderCalendar();
  updateKPI();
}

function addRow(){
  if(currentRole!=='admin') return showToast('Admin only');
  const tr=document.querySelector('#assetTable tbody').insertRow();
  tr.insertCell().innerHTML='<input type="checkbox" class="rowCheck">';
  for(let i=0;i<9;i++){
    const td=tr.insertCell();
    td.contentEditable=(i===8);
    if(i===8){
      td.addEventListener('input',()=>{
        applyRemarkStyle(tr,td);
        saveTable();
      });
    }
  }
}

function saveTable(){
  const rows=[...document.querySelectorAll('#assetTable tbody tr')]
    .map(r=>[...r.querySelectorAll('td')].slice(1).map(c=>c.innerText.trim()));
  localStorage.setItem(STORAGE_KEY,JSON.stringify(rows));
}

function parseDateSafe(value){
  if(!value) return null;
  if(!isNaN(value) && Number(value)>30000){
    return new Date((Number(value)-25569)*86400*1000);
  }
  const parsed=new Date(value);
  if(!isNaN(parsed)) return parsed;
  if(typeof value==='string' && value.includes('/')){
    const parts=value.split('/');
    if(parts.length===3){
      return new Date(parts[2],parts[1]-1,parts[0]);
    }
  }
  return null;
}

function formatDateDisplay(dateObj){
  if(!dateObj) return '';
  const y=dateObj.getFullYear();
  const m=String(dateObj.getMonth()+1).padStart(2,'0');
  const d=String(dateObj.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

function loadTable(){
  const tbody=document.querySelector('#assetTable tbody');
  tbody.innerHTML='';
  const data=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');

  data.forEach(rowData=>{
    const parsedDate=parseDateSafe(rowData[7]);
    if(!parsedDate || parsedDate.getFullYear()!==selectedYear) return;

    const tr=tbody.insertRow();
    tr.insertCell().innerHTML='<input type="checkbox" class="rowCheck">';

    for(let i=0;i<9;i++){
      const td=tr.insertCell();
      td.contentEditable=(i===8);

      if(i===7){
        const parsed=parseDateSafe(rowData[i]);
        td.innerText=formatDateDisplay(parsed);
      }else{
        td.innerText=rowData[i]||'';
      }

      if(i===8){
        td.addEventListener('input',()=>{
          applyRemarkStyle(tr,td);
          saveTable();
        });
      }
    }

    if(rowData[8]){
      const remarkCell=tr.children[9];
      applyRemarkStyle(tr,remarkCell);
    }
  });
}

function deleteSelected(){
  if(currentRole!=='admin') return showToast('Admin only');
  document.querySelectorAll('.rowCheck:checked').forEach(cb=>cb.closest('tr').remove());
  saveTable(); renderCalendar(); updateKPI();
}

function toggleSelectAll(flag){
  document.querySelectorAll('.rowCheck').forEach(cb=>cb.checked=flag);
}

function rescheduleSelected(){
  const checked=[...document.querySelectorAll('.rowCheck:checked')];
  if(!checked.length) return showToast('Select at least one row');

  for(const cb of checked){
    const row=cb.closest('tr');
    const remark=row.children[9].innerText.trim();
    if(remark){
      return showToast('Reschedule blocked: Asset already DONE');
    }
  }

  const newDate=prompt('Enter new date (YYYY-MM-DD):');
  if(!newDate) return;

  checked.forEach(cb=>{
    const row=cb.closest('tr');
    const old=row.children[8].innerText;
    row.children[8].innerText=newDate;
    const remarkCell=row.children[9];
    remarkCell.innerText=`Rescheduled from ${old} to ${newDate}`;
    applyRemarkStyle(row,remarkCell);
  });

  saveTable(); renderCalendar(); updateKPI();
}

function searchTable(){
  const q=document.getElementById('searchBox').value.toLowerCase();
  document.querySelectorAll('#assetTable tbody tr').forEach(r=>{
    r.style.display=r.innerText.toLowerCase().includes(q)?'':'none';
  });
}

function renderCalendar(){
  const label=document.getElementById('monthLabel');
  label.textContent=viewDate.toLocaleString('default',{month:'long',year:'numeric'});
  const y=viewDate.getFullYear();
  const m=viewDate.getMonth();
  const last=new Date(y,m+1,0);
  let html='<div class="cal-grid">';

  const map={};
  const rows=[...document.querySelectorAll('#assetTable tbody tr')];

  rows.forEach(r=>{
    const parsed=parseDateSafe(r.children[8].innerText);
    if(!parsed) return;
    if(parsed.getFullYear()!==y || parsed.getMonth()!==m) return;
    const key=parsed.getDate();
    if(!map[key]) map[key]=[];
    map[key].push(r);
  });

  for(let i=1;i<=last.getDate();i++){
    const count=map[i]?map[i].length:'';
    html+=`<div class="day" onclick="showDayDetail(${i})"><b>${i}</b><div>${count}</div></div>`;
  }
  html+='</div>';
  document.getElementById('calendar').innerHTML=html;
  window._calendarMap=map;
}

function showDayDetail(day){
  const card=document.getElementById('dayDetailCard');
  const content=document.getElementById('dayDetailContent');
  const list=window._calendarMap?.[day]||[];
  if(!list.length){
    content.innerHTML='<div style="color:#888">No asset scheduled for this day</div>';
    card.style.display='block';
    return;
  }

  let html='<table style="width:100%;border-collapse:collapse">';
  html+='<tr style="color:#ffaa00"><th style="text-align:left">ASSET NO</th><th style="text-align:left">DESCRIPTION</th><th style="text-align:left">TARGET DATE</th></tr>';

  list.slice(0,10).forEach(r=>{
    const assetNo=r.children[1].innerText;
    html+=`<tr style="cursor:pointer" onclick="scrollToAsset('${assetNo}')">
      <td style="color:#00e5ff">${assetNo}</td>
      <td>${r.children[3].innerText}</td>
      <td>${r.children[8].innerText}</td>
    </tr>`;
  });

  html+='</table>';
  content.innerHTML=html;
  card.style.display='block';
}

function prevMonth(){ viewDate.setMonth(viewDate.getMonth()-1); renderCalendar(); }
function nextMonth(){ viewDate.setMonth(viewDate.getMonth()+1); renderCalendar(); }

function updateKPI(){
  const rows=[...document.querySelectorAll('#assetTable tbody tr')];
  const total=rows.length;
  const done=rows.filter(r=>r.children[9].innerText.trim()).length;
  document.getElementById('kpiTotal').innerText=total;
  document.getElementById('kpiDone').innerText=done;
  document.getElementById('kpiPending').innerText=total-done;
  document.getElementById('kpiMonth').innerText=total;
}

function scrollToAsset(assetNo){
  const rows=[...document.querySelectorAll('#assetTable tbody tr')];
  let targetRow=null;
  rows.forEach(r=>{
    if(r.children[1].innerText===assetNo){ targetRow=r; }
    r.style.outline='none';
  });
  if(targetRow){
    targetRow.scrollIntoView({behavior:'smooth',block:'center'});
    targetRow.style.outline='2px solid #00e5ff';
    setTimeout(()=>targetRow.style.outline='none',3000);
  }
}

function applyRemarkStyle(row,cell){
  const text=cell.textContent.trim();
  if(text){
    row.classList.add('hasRemark');
    cell.classList.add('remarkText');
    autoGenerateNextPPM(row);
  }else{
    row.classList.remove('hasRemark');
    cell.classList.remove('remarkText');
  }
}

function autoGenerateNextPPM(row){
  const freq=row.children[7].innerText.trim().toLowerCase();
  const targetStr=row.children[8].innerText.trim();
  const parsed=parseDateSafe(targetStr);
  if(!parsed) return;

  let nextDate=new Date(parsed);
  const weekMatch=freq.match(/(\d+)\s*week/);
  if(weekMatch){
    const weeks=parseInt(weekMatch[1]);
    nextDate.setDate(nextDate.getDate()+(weeks*7));
  }else{
    return;
  }

  const tbody=document.querySelector('#assetTable tbody');
  const newRow=tbody.insertRow();
  newRow.insertCell().innerHTML='<input type="checkbox" class="rowCheck">';

  for(let i=1;i<=9;i++){
    const td=newRow.insertCell();
    td.contentEditable=(i===9);
    if(i===8){
      td.innerText=formatDateDisplay(nextDate);
    }else if(i===9){
      td.innerText='';
      td.addEventListener('input',()=>{
        applyRemarkStyle(newRow,td);
        saveTable();
      });
    }else{
      td.innerText=row.children[i].innerText;
    }
  }

  saveTable();
  renderCalendar();
  updateKPI();
}

function showToast(msg){
  const t=document.getElementById('toast');
  t.innerText=msg;
  t.style.display='block';
  setTimeout(()=>t.style.display='none',3000);
}

function triggerImport(){
  if(currentRole!=='admin') return showToast('Admin only');
  document.getElementById('excelFile').click();
}

function exportExcel(){
  const rows=[...document.querySelectorAll('#assetTable tbody tr')]
    .map(r=>[...r.querySelectorAll('td')].slice(1).map(c=>c.innerText.trim()));
  if(!rows.length) return showToast('No data to export');
  const ws=XLSX.utils.aoa_to_sheet([
    ['ASSET NO','TYPE CODE','ASSET DESCRIPTION','DISCIPLINE','CODE LOCATION','LOCATION','FREQUENCY','TARGET DATE','REMARK'],
    ...rows
  ]);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Maintenance');
  XLSX.writeFile(wb,'Maintenance_Data.xlsx');
}
</script>

</body>
</html>
