<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Maintenance Schedule</title>
<link rel="icon" type="image/png" href="img/JKB logo.png">
<style>
body{font-family:'Segoe UI',Arial,sans-serif;margin:0;padding:20px;background:#eef2f7;color:#2c3e50}
table{border-collapse:separate;border-spacing:0;width:100%;background:#fff;border-radius:12px;overflow:hidden}
th,td{border-bottom:1px solid #e6e9ef;padding:8px 10px;font-size:12px}
th{background:#2d6cdf;color:#fff;position:sticky;top:0}
.hasRemark{background:#d4edda}
.remarkIcon{margin-left:4px;color:#27ae60;font-weight:bold}
.overdueIcon{margin-left:6px;color:#e67e22;font-weight:bold}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:5px}
.day{border:1px solid #ddd;padding:4px;border-radius:6px;cursor:pointer;font-size:11px}
#loadingOverlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:1000}
.loader{width:70px;height:70px;background:url('img/JKB logo.png') center/contain no-repeat;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" style="min-height:100vh;display:flex;flex-direction:column;justify-content:flex-end;align-items:center;background:url('img/background.png') center/cover no-repeat;padding-bottom:60px">
  <div id="loadingOverlay"><div class="loader"></div></div>
  <div style="width:320px">
    <h2>Log in</h2>
    <input id="loginUser" placeholder="Username" style="width:100%;padding:10px;margin-bottom:10px">
    <input id="loginPass" type="password" placeholder="Password" style="width:100%;padding:10px;margin-bottom:10px">
    <button onclick="login()" style="background:#f0ad2c;border:none;padding:10px 20px">LOG IN</button>
  </div>
</div>

<!-- DASHBOARD -->
<div id="homePage" style="display:none;padding:40px">
  <h2 style="margin-top:0">Dashboard</h2>

  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-top:20px">
    <div onclick="openSystem('edgenta')" style="cursor:pointer;background:white;border-radius:16px;padding:20px;box-shadow:0 8px 18px rgba(0,0,0,.1);text-align:center;transition:.2s">
      <img src="img/UEM.jpg" style="height:70px;object-fit:contain" onerror="this.onerror=null;this.src='https://dummyimage.com/120x60/cccccc/000000&text=UEM';"><div style="margin-top:10px;font-weight:600">Asset by Edgenta</div>
    </div>

    <div onclick="openSystem('jkb')" style="cursor:pointer;background:white;border-radius:16px;padding:20px;box-shadow:0 8px 18px rgba(0,0,0,.1);text-align:center;transition:.2s">
      <img src="img/JKB logo.png" style="height:70px;object-fit:contain" onerror="this.onerror=null;this.src='https://dummyimage.com/120x60/cccccc/000000&text=JKB';"><div style="margin-top:10px;font-weight:600">Asset by JKB</div>
    </div>
  </div>
</div>

<!-- SYSTEM -->
<div id="mainSystem" style="display:none">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
  <h2 style="margin:0">Asset Maintenance Schedule</h2>
  <div>
    <button onclick="prevMonth()">‚óÄ</button>
    <span id="monthLabel" style="margin:0 8px;font-weight:600"></span>
    <button onclick="nextMonth()">‚ñ∂</button>
  </div>
  <button onclick="toggleBubble()" style="border-radius:20px;padding:6px 12px">‚ò∞ Menu</button>
</div>

<!-- BUBBLE MENU -->
<div id="bubbleMenu" style="display:none;position:fixed;right:20px;top:120px;background:white;border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,.15);padding:10px;z-index:999">
  <div><button onclick="goDashboard()">üè† Dashboard</button></div>
  <div><button onclick="openSystem('edgenta')">UEM Edgenta</button></div>
  <div><button onclick="openSystem('jkb')">JKB</button></div>
</div>

<div style="margin:10px 0">
  <button id="addRowBtn" onclick="addRow()">Add Row</button>
  <button onclick="deleteSelected()">Delete</button>
  <button onclick="viewDeleteHistory()">History</button>
  <span id="selectedInfo" style="margin-left:10px;font-size:12px;color:#666"></span>
  <button onclick="toggleSelectAll()">Select All</button>
  <input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none" onchange="importExcel(event)">
  <button id="importBtn" onclick="triggerImport()">Import Excel</button>
  <button onclick="openReschedule()">Reschedule</button>
  <button onclick="resetFilter()">Show All</button>
</div>

<div id="calendar"></div>

<div style="max-height:400px;overflow:auto">
<table id="assetTable">
<thead>
<tr>
<th style="width:30px"><input type="checkbox" id="checkAll" onclick="toggleSelectAll(this.checked)"></th>
<th>ASSET NO</th>
<th>TYPE CODE</th>
<th>ASSET DESCRIPTION</th>
<th>DISCIPLINE</th>
<th>LOCATION</th>
<th>CODE LOCATION</th>
<th>FREQUENCY</th>
<th>TARGET DATE</th>
<th>REMARK</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<!-- RESCHEDULE -->
<div id="rescheduleModal" style="position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center">
  <div style="background:#fff;padding:15px;width:300px">
    <h3>Reschedule</h3>
    <div id="rescheduleList" style="max-height:150px;overflow:auto"></div>
    <input type="date" id="rescheduleDate" style="width:100%;margin:10px 0">
    <button onclick="saveReschedule()">Save</button>
    <button onclick="closeReschedule()">Cancel</button>
  </div>
</div>

</div>

<script>
const STORAGE_KEY='assetTableData';
let currentRole='user';
let viewDate=new Date();

window.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('loginPage').style.display='flex';
});

const LOGIN_API='https://script.google.com/macros/s/AKfycbwd1m0fzsqRdlAkugSqDRUAoIk9yRXf_8hE_VLV3rXDzZ4PfuR9dHy57gXbUq3ygGMy/exec';

async function login(){
  const loading=document.getElementById('loadingOverlay');
  if(loading) loading.style.display='flex';

  const u=document.getElementById('loginUser').value.trim();
  const p=document.getElementById('loginPass').value.trim();

  try{
    const url=`${LOGIN_API}?username=${encodeURIComponent(u)}&password=${encodeURIComponent(p)}`;
    const res=await fetch(url);
    const data=await res.json();

    if(loading) loading.style.display='none';

    if(data.ok){
      currentRole=data.role||'user';
      localStorage.setItem('loggedUser',JSON.stringify({u,role:currentRole}));
      document.getElementById('loginPage').style.display='none';
      document.getElementById('homePage').style.display='block';
    }else alert('Invalid login');
  }catch(e){
    if(loading) loading.style.display='none';
    alert('Server error');
  }
}

function goDashboard(){
  document.getElementById('mainSystem').style.display='none';
  document.getElementById('homePage').style.display='block';
}

function toggleBubble(){
  const b=document.getElementById('bubbleMenu');
  b.style.display=b.style.display==='none'?'block':'none';
}

function openSystem(type){
  document.getElementById('homePage').style.display='none';
  document.getElementById('mainSystem').style.display='block';
  loadTable();
  renderCalendar();
}

function triggerImport(){
  if(currentRole!=='admin') return alert('Admin only');
  document.getElementById('excelFile').click();
}

function importExcel(e){
  if(currentRole!=='admin') return;
  const file=e.target.files[0];
  if(!file) return;

  const reader=new FileReader();
  reader.onload=function(evt){
    const data=new Uint8Array(evt.target.result);
    const wb=XLSX.read(data,{type:'array'});
    const sheet=wb.Sheets[wb.SheetNames[0]];
    const json=XLSX.utils.sheet_to_json(sheet,{header:1});

    const header=(json[0]||[]).map(v=>String(v||'').trim().toUpperCase());
    const template=[
      'ASSET NO','TYPE CODE','ASSET DESCRIPTION','DISCIPLINE','LOCATION','CODE LOCATION','FREQUENCY','TARGET DATE','REMARK'
    ];

    const same=template.every((h,i)=>header[i]===h);
    if(!same){
      alert('Invalid template. Please use official format.');
      return;
    }

    const tbody=document.querySelector('#assetTable tbody');
    const existing=[...tbody.rows].map(r=>r.cells[0].innerText.trim());

    let insertCount=0, skipCount=0, invalidDate=0;
    const preview=[];

    json.slice(1).forEach(r=>{
      const asset=(r[0]||'').toString().trim();
      if(!asset){ skipCount++; return; }
      if(existing.includes(asset)){ skipCount++; return; }

      let date=r[7];
      let parsed=new Date(date);
      if(typeof date==='number'){
        parsed=new Date(Math.round((date-25569)*86400*1000));
      }
      if(isNaN(parsed)) invalidDate++;

      preview.push({asset,row:r,parsed});
    });

    if(!preview.length){
      alert('No new data to import.');
      return;
    }

    if(!confirm(`Import ${preview.length} new asset(s)?
Skip: ${skipCount}
Invalid date: ${invalidDate}`)) return;

    preview.forEach(obj=>{
      const tr=tbody.insertRow();
      for(let i=0;i<9;i++){
        const td=tr.insertCell();
        td.contentEditable=currentRole==='admin';
        if(i===7 && !isNaN(obj.parsed)){
          td.textContent=obj.parsed.toISOString().split('T')[0];
        }else{
          td.textContent=obj.row[i]||'';
        }
      }

      if(obj.row[8]){
        tr.classList.add('hasRemark');
        const icon=document.createElement('span');
        icon.className='remarkIcon';
        icon.textContent='‚úî';
        tr.children[8].appendChild(icon);
      }

      insertCount++;
    });

    saveTable();
    renderCalendar();
    alert(`Import done. Insert: ${insertCount}, Skip: ${skipCount}, Invalid date: ${invalidDate}`);
  };
  reader.readAsArrayBuffer(file);
}

// ===== DRAG & DROP =====
document.addEventListener('dragover',e=>{ e.preventDefault(); });
document.addEventListener('drop',e=>{
  if(currentRole!=='admin') return;
  e.preventDefault();
  const f=e.dataTransfer.files[0];
  if(!f) return;
  document.getElementById('excelFile').files=e.dataTransfer.files;
  importExcel({target:{files:[f]}});
});

function addRow(){
  if(currentRole!=='admin') return;
  const tr=document.querySelector('#assetTable tbody').insertRow();
  const cbCell=tr.insertCell();
  const cb=document.createElement('input');
  cb.type='checkbox';
  cb.className='rowCheck';
  cbCell.appendChild(cb);
  for(let i=0;i<9;i++){
    const td=tr.insertCell();
    td.contentEditable='true';
  }
  saveTable();
}

function saveTable(){
  const rows=[...document.querySelectorAll('#assetTable tbody tr')]
    .map(r=>[...r.querySelectorAll('td')].slice(1).map(c=>c.innerText.replace('‚úî','').trim()));
  localStorage.setItem(STORAGE_KEY,JSON.stringify(rows));
}

function loadTable(){
  const tbody=document.querySelector('#assetTable tbody');
  tbody.innerHTML='';
  const data=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');

  data.forEach(r=>{
    const tr=tbody.insertRow();
    const cbCell=tr.insertCell();
    const cb=document.createElement('input');
    cb.type='checkbox';
    cb.className='rowCheck';
    cbCell.appendChild(cb);

    for(let i=0;i<9;i++){
      const td=tr.insertCell();
      td.contentEditable=currentRole==='admin';
      td.textContent=r[i]||'';
    }

    if(r[8]){
      tr.classList.add('hasRemark');
      const icon=document.createElement('span');
      icon.className='remarkIcon';
      icon.textContent='‚úî';
      tr.children[9].appendChild(icon);
    }
  });
}


// remark update
document.addEventListener('input',e=>{
  if(e.target.tagName!=='TD') return;
  const row=e.target.parentElement;
  const cell=row.children[8];
  const val=cell.innerText.replace('‚úî','').trim();
  row.classList.toggle('hasRemark',!!val);
  saveTable();
});

function renderCalendar(){
  const label=document.getElementById('monthLabel');
  if(label) label.textContent=viewDate.toLocaleString('default',{month:'long',year:'numeric'});
  const y=viewDate.getFullYear();
  const m=viewDate.getMonth();
  const last=new Date(y,m+1,0);

  const map={};
  window.calendarMap=map;

  document.querySelectorAll('#assetTable tbody tr').forEach(r=>{
    const a=r.children[0].innerText.trim();
    const t=r.children[7].innerText.trim();
    const d=new Date(t);
    if(a && !isNaN(d)){
      const k=d.getFullYear()+'-'+d.getMonth()+'-'+d.getDate();
      if(!map[k]) map[k]=[];
      map[k].push(a);
    }
  });

  let html='<div class="cal-grid">';
  for(let d=1;d<=last.getDate();d++){
    const key=y+'-'+m+'-'+d;
    const list=map[key]||[];
    let txt=list.slice(0,20).join(', ');
    if(list.length>20) txt+=` (+${list.length-20} more)`;
    html+=`<div class="day" onclick="filterByDay(${y},${m},${d})"><b>${d}</b><div>${txt}</div></div>`;
  }
  html+='</div>';

  document.getElementById('calendar').innerHTML=html;
}

function filterByDay(y,m,d){
  document.querySelectorAll('#assetTable tbody tr').forEach(r=>{
    const t=r.children[7].innerText.trim();
    const dt=new Date(t);
    if(!isNaN(dt)&&dt.getFullYear()===y&&dt.getMonth()===m&&dt.getDate()===d) r.style.display='';
    else r.style.display='none';
  });
}

function openReschedule(){
  const box=document.getElementById('rescheduleList');
  box.innerHTML='';
  document.querySelectorAll('#assetTable tbody tr').forEach((r,i)=>{
    const a=r.children[0].innerText.trim();
    if(!a) return;
    box.innerHTML+=`<div><label><input type='checkbox' data-row='${i}'> ${a}</label></div>`;
  });
  document.getElementById('rescheduleModal').style.display='flex';
}

function closeReschedule(){
  document.getElementById('rescheduleModal').style.display='none';
}

function saveReschedule(){
  const date=document.getElementById('rescheduleDate').value;
  if(!date) return alert('Pick date');
  const rows=[...document.querySelectorAll('#assetTable tbody tr')];
  document.querySelectorAll('#rescheduleList input:checked').forEach(cb=>{
    const r=rows[cb.dataset.row];
    if(r) r.children[7].innerText=date;
  });
  saveTable();
  renderCalendar();
  closeReschedule();
}

function prevMonth(){ viewDate.setMonth(viewDate.getMonth()-1); renderCalendar(); }
function nextMonth(){ viewDate.setMonth(viewDate.getMonth()+1); renderCalendar(); }

let lastDeleted=[];
let deleteHistory=JSON.parse(localStorage.getItem('deleteHistory')||'[]');

function updateSelectedInfo(){
  const boxes=[...document.querySelectorAll('.rowCheck')];
  const n=boxes.filter(b=>b.checked).length;
  const el=document.getElementById('selectedInfo');
  if(el) el.textContent=n?`${n} selected`:'';
}

document.addEventListener('change',e=>{
  if(e.target.classList.contains('rowCheck')||e.target.id==='checkAll') updateSelectedInfo();
});

function toggleSelectAll(flag){
  const boxes=document.querySelectorAll('.rowCheck');
  if(typeof flag==='boolean') boxes.forEach(b=>b.checked=flag);
  else{
    const all=[...boxes].every(b=>b.checked);
    boxes.forEach(b=>b.checked=!all);
  }
}

function deleteSelected(){
  if(currentRole!=='admin') return alert('Admin only');
  const rows=[...document.querySelectorAll('#assetTable tbody tr')];
  const targets=rows.filter(r=>{
    const cb=r.querySelector('.rowCheck');
    return cb&&cb.checked;
  });

  if(!targets.length) return alert('No row selected');
  if(!confirm(`Delete ${targets.length} selected row(s)?`)) return;

  const snapshot=targets.map(r=>[...r.querySelectorAll('td')].slice(1).map(c=>c.innerText.replace('‚úî','').trim()));

  // simpan ke history
  deleteHistory.push({
    time:new Date().toISOString(),
    total:snapshot.length,
    data:snapshot
  });
  localStorage.setItem('deleteHistory',JSON.stringify(deleteHistory));

  lastDeleted=snapshot;
  targets.forEach(r=>r.remove());

  saveTable();
  renderCalendar();
  updateSelectedInfo();

  const undo=confirm(`${targets.length} row deleted. Undo?`);
  if(undo && lastDeleted.length){
    restoreRows(lastDeleted);
    deleteHistory.pop();
    localStorage.setItem('deleteHistory',JSON.stringify(deleteHistory));
    lastDeleted=[];
  }
}

function restoreRows(rowsData){
  const tbody=document.querySelector('#assetTable tbody');
  rowsData.forEach(data=>{
    const tr=tbody.insertRow();
    const cbCell=tr.insertCell();
    const cb=document.createElement('input');
    cb.type='checkbox';
    cb.className='rowCheck';
    cbCell.appendChild(cb);
    for(let i=0;i<9;i++){
      const td=tr.insertCell();
      td.contentEditable=currentRole==='admin';
      td.textContent=data[i]||'';
    }
  });
  saveTable();
  renderCalendar();
}

function viewDeleteHistory(){
  if(!deleteHistory.length) return alert('No history');

  let msg='Delete History:\n\n';
  deleteHistory.forEach((h,i)=>{
    msg+=`${i+1}. ${new Date(h.time).toLocaleString()} - ${h.total} row(s)\n`;
  });

  const pick=prompt(msg+'\nType number to restore:');
  const id=parseInt(pick)-1;
  if(deleteHistory[id]){
    restoreRows(deleteHistory[id].data);
    deleteHistory.splice(id,1);
    localStorage.setItem('deleteHistory',JSON.stringify(deleteHistory));
  }
}

function resetFilter(){
  document.querySelectorAll('#assetTable tbody tr').forEach(r=>r.style.display='');
}
// XLSX LIB
</script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

</body>
</html>
