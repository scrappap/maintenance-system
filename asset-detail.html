<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Asset Detail</title>
<link rel="icon" type="image/png" href="img/JKB logo.png">

<style>
body{
  background:#0b1118;
  color:#cfefff;
  font-family:'Segoe UI',Arial,sans-serif;
  padding:25px;
}

.card{
  background:#121c26;
  border:1px solid #00e5ff33;
  border-radius:14px;
  padding:20px;
  margin-top:20px;
}

.btn{
  border:1px solid #00e5ff55;
  background:#111a24;
  color:#00e5ff;
  padding:6px 12px;
  border-radius:6px;
  cursor:pointer;
}

.label{
  color:#ffaa00;
  font-size:12px;
}

.value{
  margin-bottom:12px;
}

.form-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
}

.form-group{
  display:flex;
  flex-direction:column;
}

.form-group input{
  background:#0f1822;
  border:1px solid #00e5ff33;
  color:#00e5ff;
  padding:6px;
  border-radius:6px;
}
/* Loading overlay */
.loading-overlay{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.6);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
  display:none;
}

.spinner{
  width:50px;
  height:50px;
  border:5px solid #00e5ff33;
  border-top:5px solid #00e5ff;
  border-radius:50%;
  animation:spin 1s linear infinite;
}

@keyframes spin{
  0%{transform:rotate(0deg);}
  100%{transform:rotate(360deg);}
}

/* Disabled Save Button */
.btn:disabled{
  opacity:0.5;
  cursor:not-allowed;
}
</style>
</head>
<body>

<h2>Asset Detail</h2>

<button class="btn" onclick="goBack()">Back</button>

<div id="detailBox" class="card">
  Loading...
</div>

<div style="margin-top:15px">
  <button class="btn" id="editBtn" onclick="enableEdit()">Edit</button>
  <button class="btn" id="saveBtn" onclick="saveDetail()" style="display:none">
    Save
  </button>
</div>
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
</div>
  
<script>

const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbwAJl-cEwnDnQpeSQAruRe4eeaH-BO9PTfTW2q-JZ5sXIF7p2m0usnj2IPoBdktdf7B4A/exec";
const SESSION_KEY='pm_user_session';


  
// Protect page
const session = JSON.parse(localStorage.getItem(SESSION_KEY));
if(!session){
  window.location.href="maintenance-system.html";
}

const assetNo = new URLSearchParams(window.location.search).get("asset") || "";

if(assetNo === ""){
  document.getElementById("detailBox").innerHTML =
    "<b style='color:red'>Asset No missing from URL</b>";
  throw new Error("AssetNo kosong");
}


// ðŸ”¥ CALL DETAIL READ
let currentAsset = null;

document.getElementById("detailBox").innerHTML = "Loading...";
console.time("detailLoad");

showLoading();
  
fetch(SHEET_API_URL + "?action=detailRead&assetNo=" + encodeURIComponent(assetNo))
.then(res=>res.json())
.then(asset=>{
  hideLoading();

  currentAsset = asset;

document.getElementById("detailBox").innerHTML = `

<div class="form-group">
  <span class="label">Asset No</span>
  <input id="assetNo" value="${asset.assetNo || ""}" readonly>
</div>

<div class="form-grid">

  ${inputField("Bumi","bumi",asset.bumi)}
  ${inputField("Vendor","vendor",asset.vendor)}

  ${inputField("Contact Bumi","contactBumi",asset.contactBumi)}
  ${inputField("Contact Vendor","contactVendor",asset.contactVendor)}

  ${inputField("Manufacturer","manufacturer",asset.manufacturer)}
  ${inputField("Brand","brand",asset.brand)}

  ${inputField("Model","model",asset.model)}
  ${inputField("Serial Number","serialNumber",asset.serialNumber)}

  ${inputField("Price","price",asset.price)}
  ${inputField("LO No","loNo",asset.loNo)}

  ${inputField("Category","category",asset.category)}
  ${inputField("Start Date","startDate",asset.startDate)}

  ${inputField("End Date","endDate",asset.endDate)}

</div>
`;
  
})
.catch(err=>{
  document.getElementById("detailBox").innerHTML="Connection error";
  console.error(err);
});

function inputField(label,id,value){
  return `
    <div class="form-group">
      <span class="label">${label}</span>
      <input id="${id}" value="${value || ""}" readonly>
    </div>
  `;
}

function saveDetail(){

  const saveBtn = document.getElementById("saveBtn");

  // Disable button + show loading
  saveBtn.disabled = true;
  showLoading();

  const data = {
    action:"detailUpdate",
    assetNo: document.getElementById("assetNo").value,
    bumi: document.getElementById("bumi").value,
    contactBumi: document.getElementById("contactBumi").value,
    vendor: document.getElementById("vendor").value,
    contactVendor: document.getElementById("contactVendor").value,
    manufacturer: document.getElementById("manufacturer").value,
    brand: document.getElementById("brand").value,
    model: document.getElementById("model").value,
    serialNumber: document.getElementById("serialNumber").value,
    price: document.getElementById("price").value,
    loNo: document.getElementById("loNo").value,
    category: document.getElementById("category").value,
    startDate: document.getElementById("startDate").value,
    endDate: document.getElementById("endDate").value
  };

  fetch(SHEET_API_URL,{
    method:"POST",
    body:new URLSearchParams(data)
  })
  .then(res=>res.json())
  .then(()=>{

    alert("Detail Updated Successfully");

    document.querySelectorAll("#detailBox input")
      .forEach(input=>{
        input.setAttribute("readonly",true);
      });

    document.getElementById("editBtn").style.display="inline-block";
    document.getElementById("saveBtn").style.display="none";

  })
  .catch(()=>{
    alert("Update failed");
  })
  .finally(()=>{
    hideLoading();
    saveBtn.disabled = false;
  });
}

  function enableEdit(){

  document.querySelectorAll("#detailBox input")
    .forEach(input=>{
      if(input.id !== "assetNo"){ // lock assetNo
        input.removeAttribute("readonly");
      }
    });

  document.getElementById("editBtn").style.display="none";
  document.getElementById("saveBtn").style.display="inline-block";
}
  
function goBack(){

  if(window.history.length > 1){
    window.history.back();
  } else {
    window.location.href = "index.html?open=system";
  }

}

  function showLoading(){
  document.getElementById("loadingOverlay").style.display = "flex";
}

function hideLoading(){
  document.getElementById("loadingOverlay").style.display = "none";
}
</script>

</body>

</html>






















