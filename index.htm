
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Maintenance Schedule</title>
<link rel="icon" type="image/png" href="img/JKB logo.png">

<style>
body{margin:0;font-family:'Segoe UI',Arial,sans-serif;background:#0b1118;color:#cfefff}
body::before{content:"";position:fixed;inset:0;background-image:linear-gradient(rgba(0,255,255,.04) 1px, transparent 1px),linear-gradient(90deg, rgba(0,255,255,.04) 1px, transparent 1px);background-size:40px 40px;pointer-events:none}
.card{background:#121c26;border:1px solid #00e5ff33;border-radius:14px;box-shadow:0 0 20px rgba(0,255,255,.05)}
.headerBar{background:#0f1822;border:1px solid #00e5ff33;border-radius:14px;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.title{font-size:18px;font-weight:600;color:#00e5ff;letter-spacing:1px}
.subtle{font-size:11px;color:#ffaa00}
.btn{border:1px solid #00e5ff55;background:#111a24;color:#00e5ff;padding:6px 12px;font-size:12px;border-radius:6px;cursor:pointer;transition:.2s}
.btn:hover{background:#00e5ff22;box-shadow:0 0 8px #00e5ff}
.btn-danger{border-color:#ff3b3b;color:#ff3b3b}
.btn-green{border-color:#00ffaa;color:#00ffaa}
.btn-gray{border-color:#888;color:#aaa}
.btn-amber{border-color:#ffaa00;color:#ffaa00}
.kpiWrap{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin:15px 0}
.kpi{background:#111a24;border:1px solid #00e5ff33;border-radius:10px;padding:12px;text-align:center}
.kpi h4{font-size:11px;margin:0;color:#ffaa00}
.kpi div{font-size:20px;font-weight:700;color:#00e5ff;margin-top:6px}
table{width:100%;border-collapse:collapse}
th{background:#081018;color:#00e5ff;font-size:11px;text-transform:uppercase;border-bottom:1px solid #00e5ff55;position:sticky;top:0}
th,td{padding:8px 10px;font-size:12px;border-bottom:1px solid #1e2b36}
tr:hover{background:#00e5ff11}
.hasRemark{background:#003c2f!important}
.remarkText{color:#00ffaa;font-weight:600}
td.remarkText::before{content:"âœ” ";color:#00ffaa;font-weight:bold;}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.day{border:1px solid #00e5ff33;padding:6px;border-radius:6px;font-size:11px;background:#101822;min-height:70px;cursor:pointer}
.day b{color:#ffaa00}
.day:hover{box-shadow:0 0 8px #00e5ff}
input,select{background:#0f1822;border:1px solid #00e5ff33;color:#00e5ff;border-radius:6px;padding:5px}
.toast{position:fixed;top:20px;right:20px;background:#ff3b3b;color:white;padding:10px 16px;border-radius:8px;display:none;z-index:9999}
#comingModal{
  animation: fadeIn 0.25s ease-in-out;
}

@keyframes fadeIn{
  from{opacity:0}
  to{opacity:1}
}

</style>
</head>
<body>

<div style="padding:25px">

<div id="loginPage" style="display:flex;justify-content:center;align-items:center;height:90vh">
  <div class="card" style="width:320px;padding:25px;text-align:center">
    <h2 style="color:#00e5ff;margin-bottom:20px">Login</h2>

    <input type="text" id="loginUser" placeholder="Username" style="width:100%;margin-bottom:10px">

    <input type="password" id="loginPass" placeholder="Password" style="width:100%;margin-bottom:15px">

    <button class="btn btn-green" style="width:100%" onclick="login()">
      Login
    </button>

    <div id="loginError" style="color:#ff3b3b;margin-top:10px;font-size:12px"></div>
  </div>
</div>

<div id="homePage" style="display:none">

  <h2 style="color:#00e5ff">Dashboard</h2>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-top:20px">
    <div onclick="openSystem()" class="card" style="cursor:pointer;padding:20px;text-align:center">
      <img src="img/UEM.jpg" style="height:70px;object-fit:contain">
      <div style="margin-top:10px;color:#00e5ff">Asset by Edgenta</div>
    </div>
    <div onclick="comingSoon()" class="card" style="cursor:pointer;padding:20px;text-align:center">
  <img src="img/JKB logo.png" style="height:70px;object-fit:contain">
  <div style="margin-top:10px;color:#00e5ff">Asset by JKB</div>
  </div>

  </div>
</div>

<div id="mainSystem" style="display:none;margin-top:20px">

<div class="headerBar">
  <div>
    <button class="btn btn-amber" onclick="goDashboard()">Dashboard</button>
  </div>
  <div>
    <button class="btn btn-gray" id="roleBtn">Role: admin</button>
    <button class="btn btn-danger" onclick="logout()">Logout</button>
    <select id="yearSelect" onchange="changeYear(this.value)"></select>
  </div>
  <div>
    <div class="title">Preventive Maintenance</div>
    <div class="subtle">Asset Management</div>
  </div>
</div>

<div class="kpiWrap">
  <div class="kpi">
    <h4>TOTAL (<span id="kpiYearLabel"></span>)</h4>
    <div id="kpiTotal">0</div>
  </div>

  <div class="kpi">
    <h4>DONE (<span id="kpiYearLabel2"></span>)</h4>
    <div id="kpiDone">0</div>
  </div>

  <div class="kpi">
    <h4>PENDING (<span id="kpiYearLabel3"></span>)</h4>
    <div id="kpiPending">0</div>
  </div>

  <div class="kpi">
    <h4>THIS MONTH</h4>
    <div id="kpiMonth">0</div>
  </div>
</div>

<div class="card" style="padding:12px;margin-bottom:12px;display:flex;flex-wrap:wrap;gap:8px">
  <button class="btn" onclick="addRow()">Add</button>
  <button class="btn btn-danger" onclick="deleteSelected()">Delete</button>
  <button class="btn btn-green" onclick="rescheduleSelected()">Reschedule</button>
  <button class="btn btn-amber" onclick="triggerImport()">Import</button>
  <button class="btn" onclick="exportExcel()">Export</button>
  <input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none">
  <input type="text" id="searchBox" onkeyup="searchTable()" placeholder="Search anything...">
</div>

<div style="text-align:center;margin-bottom:12px;">
  <button class="btn" onclick="prevMonth()">â—€</button>
  <span id="monthLabel" style="margin:0 10px;color:#ffaa00"></span>
  <button class="btn" onclick="nextMonth()">â–¶</button>
</div>

<div class="card" style="padding:12px;margin-bottom:12px">
  <div style="margin-bottom:6px;color:#ffaa00">Monthly Schedule</div>
  <div id="calendar"></div>
</div>

<div class="card" style="padding:12px;margin-bottom:12px;display:none" id="dayDetailCard">
  <div style="margin-bottom:6px;color:#ffaa00">Selected Day Asset List</div>
  <div id="dayDetailContent"></div>
</div>

<div class="card" style="max-height:420px;overflow:auto">
<table id="assetTable">
<thead>
<tr>
<th><input type="checkbox" onclick="toggleSelectAll(this.checked)"></th>
<th>ASSET NO</th>
<th>TYPE CODE</th>
<th>ASSET DESCRIPTION</th>
<th>DISCIPLINE</th>
<th>CODE LOCATION</th>
<th>LOCATION</th>
<th>FREQUENCY</th>
<th>TARGET DATE</th>
<th>REMARK</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

</div>


<div class="toast" id="toast"></div>
<div id="comingModal" onclick="closeComingModal()" style="

display:none;
position:fixed;
inset:0;
background:rgba(0,0,0,0.7);
justify-content:center;
align-items:center;
z-index:9999;
">

  <div onclick="event.stopPropagation()" style="
  background:#121c26;
  border:1px solid #ffaa00;
  padding:40px;
  border-radius:14px;
  text-align:center;
  box-shadow:0 0 20px #ffaa00;
  width:320px;
  ">
    <h2 style="color:#ffaa00;margin-bottom:15px">ðŸš§ COMING SOON</h2>
    <p style="color:#cfefff;margin-bottom:20px">
      Module Asset by JKB sedang dibangunkan.
    </p>
    <button class="btn btn-amber" onclick="closeComingModal()">Close</button>
  </div>

 </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>

const STORAGE_KEY='assetData';
const SESSION_KEY='pm_user_session';

let currentRole='admin';
let selectedYear=new Date().getFullYear();
let viewDate=new Date();

/* ===============================
   INIT
================================ */
window.addEventListener('DOMContentLoaded',()=>{

  const session = JSON.parse(localStorage.getItem(SESSION_KEY));

  if(session){
    currentRole = session.role;
    document.getElementById('loginPage').style.display='none';
    document.getElementById('homePage').style.display='block';
    setRole(currentRole);
  }else{
    document.getElementById('loginPage').style.display='flex';
  }

  document.getElementById('excelFile')
    .addEventListener('change', handleImport);
});


function openSystem(){
  
  setRole(currentRole);
  
  document.getElementById('homePage').style.display='none';
  document.getElementById('mainSystem').style.display='block';

  initYear();
  loadTable();
  renderCalendar();
  updateKPI();
}

function goDashboard(){
  document.getElementById('mainSystem').style.display='none';
  document.getElementById('homePage').style.display='block';
}

/* ===============================
   YEAR DROPDOWN
================================ */
function initYear(){
  const yearSelect=document.getElementById('yearSelect');
  yearSelect.innerHTML='';
  const thisYear=new Date().getFullYear();

  for(let y=thisYear-2;y<=thisYear+3;y++){
    const opt=document.createElement('option');
    opt.value=y;
    opt.textContent=y;
    if(y===selectedYear) opt.selected=true;
    yearSelect.appendChild(opt);
  }
}

function changeYear(y){
  selectedYear=parseInt(y);
  viewDate.setFullYear(selectedYear);
  renderCalendar();
  loadTable();   // TAMBAH INI
  updateKPI();
}

function getStorageKey(){
  return 'assetData_'+selectedYear;
}


/* ===============================
   CALENDAR FULL GRID
================================ */
function renderCalendar(){
  const calendar=document.getElementById('calendar');
  calendar.innerHTML='';

  const year=viewDate.getFullYear();
  const month=viewDate.getMonth();

  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();

  const label=document.getElementById('monthLabel');
  label.textContent=viewDate.toLocaleString('default',{month:'long',year:'numeric'});

  const data=JSON.parse(localStorage.getItem(getStorageKey())||'[]');

  const grid=document.createElement('div');
  grid.className='cal-grid';

  for(let i=0;i<firstDay;i++){
    const empty=document.createElement('div');
    grid.appendChild(empty);
  }

  for(let d=1;d<=daysInMonth;d++){
    const day=document.createElement('div');
    day.className='day';
    day.innerHTML='<b>'+d+'</b>';

    const fullDate=new Date(year,month,d).toLocaleDateString();

    const match=data.filter(r=>{
      if(!r[7]) return false;
      const rowDate=new Date(r[7]).toLocaleDateString();
      return rowDate===fullDate;
    });

    if(match.length>0){
      day.style.background='#003c2f';
      day.innerHTML+='<div style="color:#00ffaa;font-size:10px">'
        +match.length+' Asset</div>';
    }

    day.onclick=()=>showDayDetail(d);

    grid.appendChild(day);
  }

  calendar.appendChild(grid);
}

function prevMonth(){
  viewDate.setMonth(viewDate.getMonth()-1);
  renderCalendar();
}

function nextMonth(){
  viewDate.setMonth(viewDate.getMonth()+1);
  renderCalendar();
}


/* ===============================
   DAY DETAIL
================================ */
function showDayDetail(day){

  const card=document.getElementById('dayDetailCard');
  const content=document.getElementById('dayDetailContent');

  const year=viewDate.getFullYear();
  const month=viewDate.getMonth();

  const selectedDate=new Date(year,month,day).toLocaleDateString();

  const rows=[...document.querySelectorAll('#assetTable tbody tr')];

  const filtered=rows.filter(r=>{
    const date=r.children[8].innerText;
    if(!date) return false;
    return new Date(date).toLocaleDateString()===selectedDate;
  });

  if(filtered.length===0){
    content.innerHTML='Tiada asset pada tarikh ini';
  }else{
    content.innerHTML=filtered.map(r=>{
      const asset=r.children[1].innerText;
      const desc=r.children[3].innerText;
      const remark=r.children[9].innerText;

      const status=remark.trim() ? 
        '<span style="color:#00ffaa">DONE</span>' :
        '<span style="color:#ff3b3b">PENDING</span>';

      return `
        <div style="margin-bottom:8px;border-bottom:1px solid #1e2b36;padding-bottom:5px">
          <b>${asset}</b> - ${desc}<br>
          Status: ${status}
        </div>
      `;
    }).join('');
  }

  card.style.display='block';
}


/* ===============================
   TABLE FUNCTIONS
================================ */
function addRow(){
  const tbody=document.querySelector('#assetTable tbody');
  const tr=tbody.insertRow();
  tr.insertCell().innerHTML='<input type="checkbox" class="rowCheck">';

  for(let i=0;i<9;i++){
    const td=tr.insertCell();
    td.contentEditable=(i===8); // hanya REMARK boleh edit
  }

  saveTable();
}

function deleteSelected(){
  document.querySelectorAll('.rowCheck:checked')
    .forEach(cb=>cb.closest('tr').remove());
  saveTable();
  updateKPI();
}

function toggleSelectAll(checked){
  document.querySelectorAll('.rowCheck')
    .forEach(cb=>cb.checked=checked);
}

function searchTable(){
  const value=document.getElementById('searchBox')
    .value.toLowerCase();

  document.querySelectorAll('#assetTable tbody tr')
    .forEach(row=>{
      row.style.display=row.innerText.toLowerCase()
        .includes(value)?'':'none';
    });
}

function rescheduleSelected(){

  // ðŸ”’ Security layer
  if(currentRole === 'viewer'){
    showToast('Viewer tidak dibenarkan reschedule');
    return;
  }

  const selected=document.querySelectorAll('.rowCheck:checked');

  if(selected.length===0){
    showToast('Pilih asset dahulu');
    return;
  }

  selected.forEach(cb=>{
    const tr=cb.closest('tr');

    const freq=tr.children[7].innerText.toLowerCase();
    const dateCell=tr.children[8];
    const remarkCell=tr.children[9];

    if(!dateCell.innerText) return;

    let weeks=0;

    if(freq.includes('monthly')) weeks=4;
    else if(freq.includes('quarterly')) weeks=12;
    else if(freq.includes('semi')) weeks=26;
    else if(freq.includes('annual')) weeks=52;

    if(weeks>0){

      const newDate=new Date(dateCell.innerText);
      newDate.setDate(newDate.getDate() + (weeks*7));

      dateCell.innerText=newDate.toLocaleDateString();

      remarkCell.innerText='';
      applyRemarkStyle(tr,remarkCell);
    }
  });

  saveTable();
  renderCalendar();
  updateKPI();
  showToast('Reschedule berjaya');
}


/* ===============================
   SAVE / LOAD
================================ */
function saveTable(){
  const rows=[...document.querySelectorAll('#assetTable tbody tr')]
    .map(r=>[...r.querySelectorAll('td')]
    .slice(1)
    .map(c=>c.innerText.trim()));

  localStorage.setItem(getStorageKey(),JSON.stringify(rows));
}

function loadTable(){
  const tbody=document.querySelector('#assetTable tbody');
  tbody.innerHTML='';

  const data=JSON.parse(localStorage.getItem(getStorageKey())||'[]');

  data.forEach(rowData=>{
    const tr=tbody.insertRow();
    tr.insertCell().innerHTML='<input type="checkbox" class="rowCheck">';

    for(let i=0;i<9;i++){
      const td=tr.insertCell();
      td.contentEditable=(i===8);
      td.innerText=rowData[i]||'';

      if(i===8){
        td.addEventListener('input',()=>{
          applyRemarkStyle(tr,td);
          saveTable();
          updateKPI();
        });
      }
    }

    if(rowData[8]){
      applyRemarkStyle(tr,tr.children[9]);
    }
  });

  updateKPI();
}

function updateKPI(){

  const rows=[...document.querySelectorAll('#assetTable tbody tr')];

  const selectedYearValue = selectedYear;
  const currentMonth = viewDate.getMonth();

  let totalYear = 0;
  let doneYear = 0;
  let monthCount = 0;

  rows.forEach(r=>{

    const date=r.children[8].innerText;
    const remark=r.children[9].innerText.trim();

    if(!date) return;

    const d=new Date(date);

    if(d.getFullYear() === selectedYearValue){

      totalYear++;

      if(remark) doneYear++;

      if(d.getMonth() === currentMonth){
        monthCount++;
      }
    }

  });

  document.getElementById('kpiYearLabel').innerText = selectedYearValue;
  document.getElementById('kpiYearLabel2').innerText = selectedYearValue;
  document.getElementById('kpiYearLabel3').innerText = selectedYearValue;

  document.getElementById('kpiTotal').innerText = totalYear;
  document.getElementById('kpiDone').innerText = doneYear;
  document.getElementById('kpiPending').innerText = totalYear - doneYear;
  document.getElementById('kpiMonth').innerText = monthCount;

const pendingValue = totalYear - doneYear;

if(pendingValue > 0){
  document.getElementById('kpiPending').style.color = '#ff3b3b';
}else{
  document.getElementById('kpiPending').style.color = '#00ffaa';
}
}

function applyRemarkStyle(row,cell){
  if(!cell) return;

  if(cell.textContent.trim()){
    row.classList.add('hasRemark');
    cell.classList.add('remarkText');
  }else{
    row.classList.remove('hasRemark');
    cell.classList.remove('remarkText');
  }
}


/* ===============================
   IMPORT EXCEL (STABLE)
================================ */
function handleImport(e){
  const file=e.target.files[0];
  if(!file) return;

  const reader=new FileReader();

  reader.onload=function(evt){
    const data=new Uint8Array(evt.target.result);
    const workbook=XLSX.read(data,{type:'array'});
    const worksheet=workbook.Sheets[workbook.SheetNames[0]];
    const json=XLSX.utils.sheet_to_json(worksheet,{header:1});

    const importedRows=[];

    for(let i=1;i<json.length;i++){
      const row=json[i];
      if(!row.length) continue;

      importedRows.push([
        row[0]||'',row[1]||'',row[2]||'',row[3]||'',
        row[4]||'',row[5]||'',row[6]||'',
        row[7]||'',row[8]||''
      ]);
    }

    localStorage.setItem(getStorageKey(),JSON.stringify(importedRows));
    loadTable();
    renderCalendar();
    showToast('Import berjaya');
  };

  reader.readAsArrayBuffer(file);
  e.target.value='';
}

function triggerImport(){
  document.getElementById('excelFile').click();
}

function exportExcel(){

  const data=JSON.parse(localStorage.getItem(getStorageKey())||'[]');

  if(data.length===0){
    showToast('No data');
    return;
  }

  const header=[
    'ASSET NO','TYPE CODE','ASSET DESCRIPTION',
    'DISCIPLINE','CODE LOCATION','LOCATION',
    'FREQUENCY','TARGET DATE','REMARK'
  ];

  const ws=XLSX.utils.aoa_to_sheet([header,...data]);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Maintenance');

  XLSX.writeFile(wb,'Maintenance_Schedule.xlsx');

  showToast('Export succesfull');
}
/*=========================================
LOGIN
=========================================*/
const USERS = {
  admin: { password: "admin123", role: "admin" },
  viewer: { password: "JKB123", role: "viewer" }
};

function login(){

  const user=document.getElementById('loginUser').value.trim();
  const pass=document.getElementById('loginPass').value.trim();
  const error=document.getElementById('loginError');

  if(!USERS[user] || USERS[user].password !== pass){
    error.innerText="Username or password incorrect";
    return;
  }

  currentRole=USERS[user].role;

  // Save session
  localStorage.setItem(SESSION_KEY, JSON.stringify({
    username:user,
    role:currentRole
  }));

  document.getElementById('loginPage').style.display='none';
  document.getElementById('homePage').style.display='block';

  setRole(currentRole);
}
function logout(){

  localStorage.removeItem(SESSION_KEY);

  currentRole='admin';

  document.getElementById('mainSystem').style.display='none';
  document.getElementById('homePage').style.display='none';
  document.getElementById('loginPage').style.display='flex';

location.reload();

}

function setRole(role){

  currentRole = role;

  const roleBtn = document.getElementById('roleBtn');
  if(roleBtn){
    roleBtn.innerText = 'Role: ' + role;
  }

  const isViewer = role === 'viewer';

  // Hide action buttons for viewer
  document.querySelectorAll('.btn-danger, .btn-green, .btn-amber')
    .forEach(btn=>{
      btn.style.display = isViewer ? 'none' : 'inline-block';
    });

  // Hide Add button for viewer
  const addBtn=document.querySelector('button[onclick="addRow()"]');
  if(addBtn){
    addBtn.style.display = isViewer ? 'none' : 'inline-block';
  }
}

function comingSoon(){
  document.getElementById('comingModal').style.display='flex';
}

function closeComingModal(){
  document.getElementById('comingModal').style.display='none';
}

function showToast(message){

  const toast=document.getElementById('toast');
  toast.innerText=message;
  toast.style.display='block';

  setTimeout(()=>{
    toast.style.display='none';
  },3000);
}



</script>



</body>
</html>


